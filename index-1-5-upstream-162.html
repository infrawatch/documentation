<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
<head>
<meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<meta name="generator" content="Asciidoctor 2.0.18"/>
<meta name="author" content="OpenStack Documentation Team"/>
<title>Service Telemetry Framework 1.5</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700"/>
<style>
/*! Asciidoctor default stylesheet | MIT License | https://asciidoctor.org */
/* Uncomment the following line when using as a custom stylesheet */
/* @import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700"; */
html{font-family:sans-serif;-webkit-text-size-adjust:100%}
a{background:none}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
b,strong{font-weight:bold}
abbr{font-size:.9em}
abbr[title]{cursor:help;border-bottom:1px dotted #dddddf;text-decoration:none}
dfn{font-style:italic}
hr{height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
audio,video{display:inline-block}
audio:not([controls]){display:none;height:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type=button],input[type=reset],input[type=submit]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type=checkbox],input[type=radio]{padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,::before,::after{box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;line-height:1;position:relative;cursor:auto;-moz-tab-size:4;-o-tab-size:4;tab-size:4;word-wrap:anywhere;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:0}
p{line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #dddddf;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ul.square{list-style-type:square}
ul.circle ul:not([class]),ul.disc ul:not([class]),ul.square ul:not([class]){list-style:inherit}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:1px solid #dedede;word-wrap:normal}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt{background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
:not(pre).nobreak{word-wrap:normal}
:not(pre).nowrap{white-space:nowrap}
:not(pre).pre-wrap{white-space:pre-wrap}
:not(pre):not([class^=L])>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background:#f7f7f8;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed}
pre{color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;line-height:1.45;text-rendering:optimizeSpeed}
pre code,pre pre{color:inherit;font-size:inherit;line-height:inherit}
pre>code{display:block}
pre.nowrap,pre.nowrap pre{white-space:pre;word-wrap:normal}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background:#f7f7f7;border:1px solid #ccc;border-radius:3px;box-shadow:0 1px 0 rgba(0,0,0,.2),inset 0 0 0 .1em #fff;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin:0 auto;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #dddddf}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #dddddf;padding-bottom:8px}
#header .details{border-bottom:1px solid #dddddf;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:flex;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #dddddf;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #e7e7e9;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #e7e7e9;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #e7e7e9;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border:1px solid #e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:none;background:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:hsla(0,0%,100%,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #e7e7e9}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
details,.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
details{margin-left:1.25rem}
details>summary{cursor:pointer;display:block;position:relative;line-height:1.6;margin-bottom:.625rem;outline:none;-webkit-tap-highlight-color:transparent}
details>summary::-webkit-details-marker{display:none}
details>summary::before{content:"";border:solid transparent;border-left:solid;border-width:.3em 0 .3em .5em;position:absolute;top:.5em;left:-1.25rem;transform:translateX(15%)}
details[open]>summary::before{border:solid transparent;border-top:solid;border-width:.5em .3em 0;transform:translateY(15%)}
details>summary::after{content:"";width:1.25rem;height:1em;position:absolute;top:.3em;left:-1.25rem}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class=paragraph]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #dddddf;color:rgba(0,0,0,.6);word-wrap:anywhere}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border:1px solid #e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border:1px solid #dbdbd6;margin-bottom:1.25em;padding:1.25em;background:#f3f3f2;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock>.content>pre{border-radius:4px;overflow-x:auto;padding:1em;font-size:.8125em}
@media screen and (min-width:768px){.literalblock pre,.listingblock>.content>pre{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.listingblock>.content>pre{font-size:1em}}
.literalblock pre,.listingblock>.content>pre:not(.highlight),.listingblock>.content>pre[class=highlight],.listingblock>.content>pre[class^="highlight "]{background:#f7f7f8}
.literalblock.output pre{color:#f7f7f8;background:rgba(0,0,0,.9)}
.listingblock>.content{position:relative}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:inherit;opacity:.5}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:inherit;opacity:.5}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.prettyprint{background:#f7f7f8}
pre.prettyprint .linenums{line-height:1.45;margin-left:2em}
pre.prettyprint li{background:none;list-style-type:inherit;padding-left:0}
pre.prettyprint li code[data-lang]::before{opacity:1}
pre.prettyprint li:not(:first-child) code[data-lang]::before{display:none}
table.linenotable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.linenotable td[class]{color:inherit;vertical-align:top;padding:0;line-height:inherit;white-space:normal}
table.linenotable td.code{padding-left:.75em}
table.linenotable td.linenos,pre.pygments .linenos{border-right:1px solid;opacity:.35;padding-right:.5em;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}
pre.pygments span.linenos{display:inline-block;margin-right:.75em}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock:not(.excerpt)>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.75em;margin-right:.5ex;text-align:right}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans-serif;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract blockquote::before,.quoteblock.excerpt blockquote::before,.quoteblock .quoteblock blockquote::before{display:none}
.quoteblock.abstract blockquote,.quoteblock.abstract p,.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{line-height:1.6;word-spacing:0}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.excerpt>blockquote,.quoteblock .quoteblock{padding:0 0 .25em 1em;border-left:.25em solid #dddddf}
.quoteblock.excerpt,.quoteblock .quoteblock{margin-left:0}
.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{color:inherit;font-size:1.0625rem}
.quoteblock.excerpt .attribution,.quoteblock .quoteblock .attribution{color:inherit;font-size:.85rem;text-align:left;margin-right:0}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content{margin-bottom:1.25em;word-wrap:anywhere}
td.tableblock>.content>:last-child{margin-bottom:-1.25em}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>*>tr>*{border-width:1px}
table.grid-cols>*>tr>*{border-width:0 1px}
table.grid-rows>*>tr>*{border-width:1px 0}
table.frame-all{border-width:1px}
table.frame-ends{border-width:1px 0}
table.frame-sides{border-width:0 1px}
table.frame-none>colgroup+*>:first-child>*,table.frame-sides>colgroup+*>:first-child>*{border-top-width:0}
table.frame-none>:last-child>:last-child>*,table.frame-sides>:last-child>:last-child>*{border-bottom-width:0}
table.frame-none>*>tr>:first-child,table.frame-ends>*>tr>:first-child{border-left-width:0}
table.frame-none>*>tr>:last-child,table.frame-ends>*>tr>:last-child{border-right-width:0}
table.stripes-all>*>tr,table.stripes-odd>*>tr:nth-of-type(odd),table.stripes-even>*>tr:nth-of-type(even),table.stripes-hover>*>tr:hover{background:#f8f8f7}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
li>p:empty:only-child::before{content:"";display:inline-block}
ul.checklist>li>p:first-child{margin-left:-1em}
ul.checklist>li>p:first-child>.fa-square-o:first-child,ul.checklist>li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist>li>p:first-child>input[type=checkbox]:first-child{margin-right:.25em}
ul.inline{display:flex;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
td.hdlist2{word-wrap:anywhere}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:4px solid #fff;box-shadow:0 0 0 1px #ddd}
.imageblock.left{margin:.25em .625em 1.25em 0}
.imageblock.right{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background:#00fafa}
.black{color:#000}
.black-background{background:#000}
.blue{color:#0000bf}
.blue-background{background:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background:#fa00fa}
.gray{color:#606060}
.gray-background{background:#7d7d7d}
.green{color:#006000}
.green-background{background:#007d00}
.lime{color:#00bf00}
.lime-background{background:#00fa00}
.maroon{color:#600000}
.maroon-background{background:#7d0000}
.navy{color:#000060}
.navy-background{background:#00007d}
.olive{color:#606000}
.olive-background{background:#7d7d00}
.purple{color:#600060}
.purple-background{background:#7d007d}
.red{color:#bf0000}
.red-background{background:#fa0000}
.silver{color:#909090}
.silver-background{background:#bcbcbc}
.teal{color:#006060}
.teal-background{background:#007d7d}
.white{color:#bfbfbf}
.white-background{background:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background:rgba(0,0,0,.8);border-radius:50%;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt,summary{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt,summary{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background:#fffef7;border-color:#e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]{border-bottom:1px dotted}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#header,#content,#footnotes,#footer{max-width:none}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #dddddf!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media amzn-kf8,print{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css"/>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.3/styles/monokai.min.css"/>
</head>
<body class="book toc2 toc-left">
<div id="header">
<h1>Service Telemetry Framework 1.5</h1>
<div class="details">
<span id="author" class="author">OpenStack Documentation Team</span><br/>
<span id="email" class="email"><a href="mailto:rhos-docs@redhat.com">rhos-docs@redhat.com</a></span><br/>
</div>
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#assembly-introduction-to-stf_assembly">Introduction to Service&#160;Telemetry&#160;Framework 1.5</a>
<ul class="sectlevel2">
<li><a href="#stf-architecture_assembly-introduction-to-stf">Service&#160;Telemetry&#160;Framework architecture</a></li>
<li><a href="#installation-size-of-ocp_assembly-introduction-to-stf">Installation size of OpenShift</a>
<ul class="sectlevel3">
<li><a href="#development-environment-resource-requirements_assembly-introduction-to-stf">Development environment resource requirements</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#assembly-preparing-your-ocp-environment-for-stf_assembly">Preparing your OpenShift environment for Service&#160;Telemetry&#160;Framework</a>
<ul class="sectlevel2">
<li><a href="#observability-strategy-in-service-telemetry-framework_assembly-preparing-your-ocp-environment-for-stf">Observability Strategy in Service Telemetry Framework</a></li>
<li><a href="#persistent-volumes_assembly-preparing-your-ocp-environment-for-stf">Persistent volumes</a>
<ul class="sectlevel3">
<li><a href="#ephemeral-storage_assembly-preparing-your-ocp-environment-for-stf">Ephemeral storage</a></li>
</ul>
</li>
<li><a href="#resource-allocation_assembly-preparing-your-ocp-environment-for-stf">Resource allocation</a></li>
<li><a href="#con-network-considerations-for-service-telemetry-framework_assembly-preparing-your-ocp-environment-for-stf">Network considerations for Service Telemetry Framework</a></li>
<li><a href="#node-tuning-operator_assembly-preparing-your-ocp-environment-for-stf">Node tuning operator</a></li>
</ul>
</li>
<li><a href="#assembly-installing-the-core-components-of-stf_assembly">Installing the core components of Service&#160;Telemetry&#160;Framework</a>
<ul class="sectlevel2">
<li><a href="#deploying-stf-to-the-openshift-environment_assembly-installing-the-core-components-of-stf">Deploying Service&#160;Telemetry&#160;Framework to the OpenShift environment</a></li>
<li><a href="#creating-a-servicetelemetry-object-in-openshift_assembly-installing-the-core-components-of-stf">Creating a ServiceTelemetry object in OpenShift</a>
<ul class="sectlevel3">
<li><a href="#primary-parameters-of-the-servicetelemetry-object_assembly-installing-the-core-components-of-stf">Primary parameters of the ServiceTelemetry object</a></li>
</ul>
</li>
<li><a href="#accessing-uis-for-stf-components_assembly-installing-the-core-components-of-stf">Accessing user interfaces for STF components</a></li>
<li><a href="#configuring-observability-strategy_assembly-installing-the-core-components-of-stf">Configuring an alternate observability strategy</a></li>
</ul>
</li>
<li><a href="#assembly-completing-the-stf-configuration_assembly">Configuring OpenStack for Service&#160;Telemetry&#160;Framework</a>
<ul class="sectlevel2">
<li><a href="#configuring-red-hat-openstack-platform-overcloud-for-stf_assembly-completing-the-stf-configuration">Deploying OpenStack overcloud for Service&#160;Telemetry&#160;Framework</a>
<ul class="sectlevel3">
<li><a href="#retrieving-the-qdr-route-address_assembly-completing-the-stf-configuration">Retrieving the Apache&#160;Qpid&#160;Dispatch&#160;Router route address</a></li>
<li><a href="#creating-the-base-configuration-for-stf_assembly-completing-the-stf-configuration">Creating the base configuration for STF</a></li>
<li><a href="#configuring-the-stf-connection-for-the-overcloud_assembly-completing-the-stf-configuration">Configuring the STF connection for the overcloud</a></li>
<li><a href="#deploying-the-overcloud_assembly-completing-the-stf-configuration">Deploying the overcloud</a></li>
<li><a href="#validating-clientside-installation_assembly-completing-the-stf-configuration">Validating client-side installation</a></li>
</ul>
</li>
<li><a href="#disabling-openstack-services-used-with-stf_assembly-completing-the-stf-configuration">Disabling OpenStack services used with Service&#160;Telemetry&#160;Framework</a></li>
<li><a href="#sending-metrics-to-gnocchi-and-to-stf_assembly-completing-the-stf-configuration">Sending metrics to Gnocchi and Service&#160;Telemetry&#160;Framework</a></li>
<li><a href="#deploying-to-non-standard-network-topologies_assembly-completing-the-stf-configuration">Deploying to non-standard network topologies</a></li>
<li><a href="#configuring-multiple-clouds_assembly-completing-the-stf-configuration">Configuring multiple clouds</a>
<ul class="sectlevel3">
<li><a href="#planning-amqp-address-prefixes_assembly-completing-the-stf-configuration">Planning AMQP address prefixes</a></li>
<li><a href="#deploying-smart-gateways_assembly-completing-the-stf-configuration">Deploying Smart Gateways</a></li>
<li><a href="#deleting-the-default-smart-gateways_assembly-completing-the-stf-configuration">Deleting the default Smart Gateways</a></li>
<li><a href="#setting-a-unique-cloud-domain_assembly-completing-the-stf-configuration">Setting a unique cloud domain</a></li>
<li><a href="#creating-openstack-environment-file-for-multiple-clouds_assembly-completing-the-stf-configuration">Creating the OpenStack environment file for multiple clouds</a></li>
<li><a href="#querying-metrics-data-from-multiple-clouds_assembly-completing-the-stf-configuration">Querying metrics data from multiple clouds</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#assembly-advanced-features_assembly">Using operational features of Service&#160;Telemetry&#160;Framework</a>
<ul class="sectlevel2">
<li><a href="#dashboards_assembly-advanced-features">Dashboards in Service&#160;Telemetry&#160;Framework</a>
<ul class="sectlevel3">
<li><a href="#setting-up-grafana-to-host-the-dashboard_assembly-advanced-features">Configuring Grafana to host the dashboard</a></li>
<li><a href="#overriding-the-default-grafana-container-image_assembly-advanced-features">Overriding the default Grafana container image</a></li>
<li><a href="#importing-dashboards_assembly-advanced-features">Importing dashboards</a></li>
<li><a href="#proc-retrieving-and-setting-grafana-credentials_assembly-advanced-features">Retrieving and setting Grafana login credentials</a></li>
</ul>
</li>
<li><a href="#metrics-retention-time-period_assembly-advanced-features">Metrics retention time period in Service&#160;Telemetry&#160;Framework</a>
<ul class="sectlevel3">
<li><a href="#editing-the-metrics-retention-time-period-in-service-telemetry-framework_assembly-advanced-features">Editing the metrics retention time period in Service Telemetry Framework</a></li>
</ul>
</li>
<li><a href="#alerts_assembly-advanced-features">Alerts in Service&#160;Telemetry&#160;Framework</a>
<ul class="sectlevel3">
<li><a href="#creating-an-alert-rule-in-prometheus_assembly-advanced-features">Creating an alert rule in Prometheus</a></li>
<li><a href="#configuring-custom-alerts_assembly-advanced-features">Configuring custom alerts</a></li>
<li><a href="#creating-an-alert-route-in-alertmanager_assembly-advanced-features">Creating a standard alert route in Alertmanager</a></li>
<li><a href="#creating-an-alert-route-with-templating-in-alertmanager_assembly-advanced-features">Creating an alert route with templating in Alertmanager</a></li>
</ul>
</li>
<li><a href="#configuring-snmp-traps_assembly-advanced-features">Configuring SNMP traps</a></li>
<li><a href="#high-availability_assembly-advanced-features">High availability</a>
<ul class="sectlevel3">
<li><a href="#configuring-high-availability_assembly-advanced-features">Configuring high availability</a></li>
</ul>
</li>
<li><a href="#ephemeral-storage_assembly-advanced-features">Ephemeral storage</a>
<ul class="sectlevel3">
<li><a href="#configuring-ephemeral-storage_assembly-advanced-features">Configuring ephemeral storage</a></li>
</ul>
</li>
<li><a href="#observability-strategy-in-service-telemetry-framework_assembly-advanced-features">Observability Strategy in Service Telemetry Framework</a>
<ul class="sectlevel3">
<li><a href="#configuring-observability-strategy_assembly-advanced-features">Configuring an alternate observability strategy</a></li>
<li><a href="#configuring-openshift-monitoring_assembly-advanced-features">Configuring openshift-monitoring to consume metrics from STF</a></li>
</ul>
</li>
<li><a href="#resource-usage-of-openstack-services_assembly-advanced-features">Resource usage of OpenStack services</a>
<ul class="sectlevel3">
<li><a href="#disabling-resource-usage-monitoring-of-openstack-services_assembly-advanced-features">Disabling resource usage monitoring of OpenStack services</a></li>
</ul>
</li>
<li><a href="#container-health-and-api-status_assembly-advanced-features">OpenStack API status and containerized services health</a>
<ul class="sectlevel3">
<li><a href="#disabling-container-health-and-api-status-monitoring_assembly-advanced-features">Disabling container health and API status monitoring</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#assembly-renewing-the-amq-interconnect-certificate_assembly">Renewing the Apache&#160;Qpid&#160;Dispatch&#160;Router certificate</a>
<ul class="sectlevel2">
<li><a href="#proc-checking-for-an-expired-amq-interconnect-ca-certificate_assembly-renewing-the-amq-interconnect-certificate">Checking for an expired Apache&#160;Qpid&#160;Dispatch&#160;Router CA certificate</a></li>
<li><a href="#proc-updating-the-amq-interconnect-ca-certificate_assembly-renewing-the-amq-interconnect-certificate">Updating the Apache&#160;Qpid&#160;Dispatch&#160;Router CA certificate</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<div class="sect1">
<h2 id="assembly-introduction-to-stf_assembly">Introduction to Service&#160;Telemetry&#160;Framework 1.5</h2>
<div class="sectionbody">
<div class="paragraph _abstract">
<p>Service&#160;Telemetry&#160;Framework (STF) collects monitoring data from OpenStack (OSP) or third-party nodes. You can use STF to perform the following tasks:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Store or archive the monitoring data for historical information.</p>
</li>
<li>
<p>View the monitoring data graphically on the dashboard.</p>
</li>
<li>
<p>Use the monitoring data to trigger alerts or warnings.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The monitoring data can be either metric or event:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Metric</dt>
<dd>
<p>A numeric measurement of an application or system.</p>
</dd>
<dt class="hdlist1">Event</dt>
<dd>
<p>Irregular and discrete occurrences that happen in a system.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>The components of STF use a message bus for data transport. Other modular components that receive and store data are deployed as containers on OpenShift.</p>
</div>
<div class="ulist">
<div class="title">Additional resources</div>
<ul>
<li>
<p>For more information about how to deploy OpenShift, see the  <a href="https://access.redhat.com/documentation/en-us/openshift_container_platform/4.10/">OpenShift product documentation</a>.</p>
</li>
<li>
<p>You can install OpenShift on cloud platforms or on bare metal. For more information about STF performance and scaling, see <a href="https://access.redhat.com/articles/4907241" class="bare">https://access.redhat.com/articles/4907241</a>.</p>
</li>
<li>
<p>You can install OpenShift on bare metal or other supported cloud platforms. For more information about installing OpenShift, see <a href="https://docs.openshift.com/container-platform/4.10/welcome/index.html#cluster-installer-activities">OpenShift Container Platform 4.10 Documentation</a>.</p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="stf-architecture_assembly-introduction-to-stf">Service&#160;Telemetry&#160;Framework architecture</h3>
<div class="paragraph _abstract">
<p>Service&#160;Telemetry&#160;Framework (STF) uses a client-server architecture, in which OpenStack (OSP) is the client and OpenShift is the server.</p>
</div>
<div class="paragraph">
<p>STF consists of the following components:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Data collection</p>
<div class="ulist">
<ul>
<li>
<p>collectd: Collects infrastructure metrics and events.</p>
</li>
<li>
<p>Ceilometer: Collects OSP metrics and events.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Transport</p>
<div class="ulist">
<ul>
<li>
<p>Apache&#160;Qpid&#160;Dispatch&#160;Router: An AMQP 1.x compatible messaging bus that provides fast and reliable data transport to transfer the metrics to STF for storage.</p>
</li>
<li>
<p>Smart Gateway: A Golang application that takes metrics and events from the AMQP 1.x bus to deliver to Elasticsearch or Prometheus.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Data storage</p>
<div class="ulist">
<ul>
<li>
<p>Prometheus: Time-series data storage that stores STF metrics received from the Smart Gateway.</p>
</li>
<li>
<p>Elasticsearch: Events data storage that stores STF events received from the Smart Gateway.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Observation</p>
<div class="ulist">
<ul>
<li>
<p>Alertmanager: An alerting tool that uses Prometheus alert rules to manage alerts.</p>
</li>
<li>
<p>Grafana: A visualization and analytics application that you can use to query, visualize, and explore data.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>The following table describes the application of the client and server components:</p>
</div>
<table id="table-stf-components" class="tableblock frame-all grid-all stretch">
<caption class="title">Table 1. Client and server components of STF</caption>
<colgroup>
<col style="width: 65%;"/>
<col style="width: 15%;"/>
<col style="width: 20%;"/>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Component</th>
<th class="tableblock halign-left valign-top">Client</th>
<th class="tableblock halign-left valign-top">Server</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">An AMQP 1.x compatible messaging bus</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">yes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">yes</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Smart Gateway</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">no</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">yes</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Prometheus</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">no</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">yes</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Elasticsearch</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">no</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">yes</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">collectd</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">yes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">no</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Ceilometer</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">yes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">no</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
To ensure that the monitoring platform can report operational problems with your cloud, do not install STF on the same infrastructure that you are monitoring.
</td>
</tr>
</table>
</div>
<div id="osp-stf-overview" class="imageblock">
<div class="content">
<img src="images/OpenStack_STF_Overview_37_1019_arch.png" alt="Service Telemetry Framework architecture overview"/>
</div>
<div class="title">Figure 1. Service Telemetry Framework architecture overview</div>
</div>
<div class="paragraph">
<p>For client side metrics, collectd provides infrastructure metrics without project data, and Ceilometer provides OSP platform data based on projects or user workload. Both Ceilometer and collectd deliver data to Prometheus by using the Apache&#160;Qpid&#160;Dispatch&#160;Router transport, delivering the data through the message bus. On the server side, a Golang application called the Smart Gateway takes the data stream from the bus and exposes it as a local scrape endpoint for Prometheus.</p>
</div>
<div class="paragraph">
<p>If you plan to collect and store events, collectd and Ceilometer deliver event data to the server side by using the Apache&#160;Qpid&#160;Dispatch&#160;Router transport. Another Smart Gateway writes the data to the Elasticsearch datastore.</p>
</div>
<div class="paragraph">
<p>Server-side STF monitoring infrastructure consists of the following layers:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Service&#160;Telemetry&#160;Framework 1.5</p>
</li>
<li>
<p>OpenShift 4.10</p>
</li>
<li>
<p>Infrastructure platform</p>
</li>
</ul>
</div>
<div id="osp-stf-server-side-monitoring" class="imageblock">
<div class="content">
<img src="images/STF_Overview_37_0819_deployment_prereq.png" alt="Server-side STF monitoring infrastructure"/>
</div>
<div class="title">Figure 2. Server-side STF monitoring infrastructure</div>
</div>
</div>
<div class="sect2">
<h3 id="installation-size-of-ocp_assembly-introduction-to-stf">Installation size of OpenShift</h3>
<div class="paragraph _abstract">
<p>The size of your OpenShift installation depends on the following factors:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The infrastructure that you select.</p>
</li>
<li>
<p>The number of nodes that you want to monitor.</p>
</li>
<li>
<p>The number of metrics that you want to collect.</p>
</li>
<li>
<p>The resolution of metrics.</p>
</li>
<li>
<p>The length of time that you want to store the data.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Installation of Service&#160;Telemetry&#160;Framework (STF) depends on an existing OpenShift environment.</p>
</div>
<div class="paragraph">
<p>For more information about minimum resources requirements when you install OpenShift on baremetal, see <a href="https://docs.openshift.com/container-platform/4.10/installing/installing_bare_metal/installing-bare-metal.html#minimum-resource-requirements_installing-bare-metal">Minimum resource requirements</a> in the <em>Installing a cluster on bare metal</em> guide. For installation requirements of the various public and private cloud platforms that you can install, see the corresponding installation documentation for your cloud platform of choice.</p>
</div>
<div class="sect3">
<h4 id="development-environment-resource-requirements_assembly-introduction-to-stf">Development environment resource requirements</h4>
<div class="paragraph _abstract">
<p>You can create an all-in-one development environment for STF locally by using <a href="https://code-ready.github.io/crc/">CodeReady Containers</a>. The installation process of CodeReady Containers (CRC) is available at <a href="https://code-ready.github.io/crc/#installation_gsg" class="bare">https://code-ready.github.io/crc/#installation_gsg</a>.</p>
</div>
<div class="paragraph">
<p>Deployment of OpenShift 4.10 is required for STF. The compatible version of CRC is 2.6.0, available at <a href="https://developers.redhat.com/content-gateway/rest/mirror/pub/openshift-v4/clients/crc/2.6.0/" class="bare">https://developers.redhat.com/content-gateway/rest/mirror/pub/openshift-v4/clients/crc/2.6.0/</a></p>
</div>
<div class="paragraph">
<p>The <a href="https://code-ready.github.io/crc/#minimum-system-requirements-hardware_gsg">minimum resource requirements</a> for CRC is not enough by default to run STF. Ensure that your host system has the following resources available:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>4 physical cores (8 hyperthreaded cores)</p>
</li>
<li>
<p>64 GB of memory</p>
</li>
<li>
<p>80 GB of storage space</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>After you complete the installation of CRC, you must enable cluster monitoring in the CRC environment:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-bash hljs" data-lang="bash">$ crc config set enable-cluster-monitoring true
Successfully configured enable-cluster-monitoring to true</code></pre>
</div>
</div>
</li>
<li>
<p>If you have an existing environment, delete it, and recreate it to ensure that the resource requests have an effect. Enter the <code>crc delete</code> command:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">crc delete</code></pre>
</div>
</div>
</li>
<li>
<p>Use the <code>crc start</code> command to start your environment. The recommended minimum system resources for running STF in CRC is 48 GB of memory and 8 virtual CPU cores:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">crc start --memory=49152 --cpus=8</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="assembly-preparing-your-ocp-environment-for-stf_assembly">Preparing your OpenShift environment for Service&#160;Telemetry&#160;Framework</h2>
<div class="sectionbody">
<div class="paragraph _abstract">
<p>To prepare your OpenShift environment for Service&#160;Telemetry&#160;Framework (STF), you must plan for persistent storage, adequate resources, event storage, and network considerations:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Ensure that you have persistent storage available in your OpenShift cluster for a production-grade deployment. For more information, see <a href="#persistent-volumes_assembly-preparing-your-ocp-environment-for-stf">Persistent volumes</a>.</p>
</li>
<li>
<p>Ensure that enough resources are available to run the Operators and the application containers. For more information, see <a href="#resource-allocation_assembly-preparing-your-ocp-environment-for-stf">Resource allocation</a>.</p>
</li>
<li>
<p>Ensure that you have a fully connected network environment. For more information, see <a href="#con-network-considerations-for-service-telemetry-framework_assembly-preparing-your-ocp-environment-for-stf">Network considerations for Service Telemetry Framework</a>.</p>
</li>
<li>
<p>STF uses Elasticsearch to store events, which requires a larger than normal <code>vm.max_map_count</code> value. The <code>vm.max_map_count</code> value is set by default in OpenShift. For more information about how to edit the value of <code>vm.max_map_count</code>, see <a href="#node-tuning-operator_assembly-preparing-your-ocp-environment-for-stf">Node tuning operator</a>.</p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="observability-strategy-in-service-telemetry-framework_assembly-preparing-your-ocp-environment-for-stf">Observability Strategy in Service Telemetry Framework</h3>
<div class="paragraph _abstract">
<p>Service&#160;Telemetry&#160;Framework (STF) does not include storage backends and alerting tools. STF uses community operators to deploy Prometheus, Alertmanager, Grafana, and Elasticsearch. STF makes requests to these community operators to create instances of each application configured to work with STF.</p>
</div>
<div class="paragraph">
<p>Instead of having Service Telemetry Operator create custom resource requests, you can use your own deployments of these applications or other compatible applications, and scrape the metrics Smart Gateways for delivery to your own Prometheus-compatible system for telemetry storage. If you set the observability strategy to use alternative backends instead, persistent or ephemeral storage is not required for STF.</p>
</div>
</div>
<div class="sect2">
<h3 id="persistent-volumes_assembly-preparing-your-ocp-environment-for-stf">Persistent volumes</h3>
<div class="paragraph _abstract">
<p>Service&#160;Telemetry&#160;Framework (STF) uses persistent storage in OpenShift to request persistent volumes so that Prometheus and Elasticsearch can store metrics and events.</p>
</div>
<div class="paragraph">
<p>When you enable persistent storage through the Service Telemetry Operator, the Persistent Volume Claims (PVC) requested in an STF deployment results in an access mode of RWO (ReadWriteOnce). If your environment contains pre-provisioned persistent volumes, ensure that volumes of RWO are available in the OpenShift default configured <code>storageClass</code>.</p>
</div>
<div class="ulist">
<div class="title">Additional resources</div>
<ul>
<li>
<p>For more information about configuring persistent storage for OpenShift, see <a href="https://docs.openshift.com/container-platform/4.10/storage/understanding-persistent-storage.html">Understanding persistent storage.</a></p>
</li>
<li>
<p>For more information about recommended configurable storage technology in OpenShift, see <a href="https://docs.openshift.com/container-platform/4.10/scalability_and_performance/optimizing-storage.html#recommended-configurable-storage-technology_persistent-storage">Recommended configurable storage technology</a>.</p>
</li>
<li>
<p>For more information about configuring persistent storage for Prometheus in STF, see <a href="#backends-configuring-persistent-storage-for-prometheus_assembly-installing-the-core-components-of-stf">Configuring persistent storage for Prometheus</a>.</p>
</li>
<li>
<p>For more information about configuring persistent storage for Elasticsearch in STF, see <a href="#backends-configuring-persistent-storage-for-elasticsearch_assembly-installing-the-core-components-of-stf">Configuring persistent storage for Elasticsearch</a>.</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="ephemeral-storage_assembly-preparing-your-ocp-environment-for-stf">Ephemeral storage</h4>
<div class="paragraph _abstract">
<p>You can use ephemeral storage to run Service&#160;Telemetry&#160;Framework (STF) without persistently storing data in your OpenShift cluster.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
If you use ephemeral storage, you might experience data loss if a pod is restarted, updated, or rescheduled onto another node. Use ephemeral storage only for development or testing, and not production environments.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="resource-allocation_assembly-preparing-your-ocp-environment-for-stf">Resource allocation</h3>
<div class="paragraph _abstract">
<p>To enable the scheduling of pods within the OpenShift infrastructure, you need resources for the components that are running. If you do not allocate enough resources, pods remain in a <code>Pending</code> state because they cannot be scheduled.</p>
</div>
<div class="paragraph">
<p>The amount of resources that you require to run Service&#160;Telemetry&#160;Framework (STF) depends on your environment and the number of nodes and clouds that you want to monitor.</p>
</div>
<div class="ulist">
<div class="title">Additional resources</div>
<ul>
<li>
<p>For recommendations about sizing for metrics collection, see <a href="https://access.redhat.com/articles/4907241">Service Telemetry Framework Performance and Scaling</a>.</p>
</li>
<li>
<p>For information about sizing requirements for Elasticsearch, see <a href="https://www.elastic.co/guide/en/cloud-on-k8s/current/k8s-managing-compute-resources.html" class="bare">https://www.elastic.co/guide/en/cloud-on-k8s/current/k8s-managing-compute-resources.html</a>.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="con-network-considerations-for-service-telemetry-framework_assembly-preparing-your-ocp-environment-for-stf">Network considerations for Service Telemetry Framework</h3>
<div class="paragraph">
<p>You can only deploy Service&#160;Telemetry&#160;Framework (STF) in a fully connected network environment. You cannot deploy STF in OpenShift-disconnected environments or network proxy environments.</p>
</div>
</div>
<div class="sect2">
<h3 id="node-tuning-operator_assembly-preparing-your-ocp-environment-for-stf">Node tuning operator</h3>
<div class="paragraph _abstract">
<p>STF uses Elasticsearch to store events, which requires a larger than normal <code>vm.max_map_count</code>. The <code>vm.max_map_count</code> value is set by default in OpenShift.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
If your host platform is a typical OpenShift 4 environment, do not make any adjustments. The default node tuning operator is configured to account for Elasticsearch workloads.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>If you want to edit the value of <code>vm.max_map_count</code>, you cannot apply node tuning manually using the <code>sysctl</code> command because OpenShift manages nodes directly. To configure values and apply them to the infrastructure, you must use the node tuning operator. For more information, see <a href="https://docs.openshift.com/container-platform/4.10/scalability_and_performance/using-node-tuning-operator.html">Using the Node Tuning Operator</a>.</p>
</div>
<div class="paragraph">
<p>In an OKD deployment, the default node tuning operator specification provides the required profiles for Elasticsearch workloads or pods scheduled on nodes. To view the default cluster node tuning specification, run the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">$ oc get Tuned/default -o yaml -n openshift-cluster-node-tuning-operator</code></pre>
</div>
</div>
<div class="paragraph">
<p>The output of the default specification is documented at <a href="https://docs.openshift.com/container-platform/4.10/scalability_and_performance/using-node-tuning-operator.html#custom-tuning-default-profiles-set_node-tuning-operator">Default profiles set on a cluster</a>. You can manage the assignment of profiles in the <code>recommend</code> section where profiles are applied to a node when certain conditions are met. When scheduling Elasticsearch to a node in STF, one of the following profiles is applied:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>openshift-control-plane-es</code></p>
</li>
<li>
<p><code>openshift-node-es</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>When scheduling an Elasticsearch pod, there must be a label present that matches <code>tuned.openshift.io/elasticsearch</code>. If the label is present, one of the two profiles is assigned to the pod. No action is required by the administrator if you use the recommended Operator for Elasticsearch. If you use a custom-deployed Elasticsearch with STF, ensure that you add the <code>tuned.openshift.io/elasticsearch</code> label to all scheduled pods.</p>
</div>
<div class="ulist">
<div class="title">Additional resources</div>
<ul>
<li>
<p>For more information about virtual memory use by Elasticsearch, see <a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/vm-max-map-count.html" class="bare">https://www.elastic.co/guide/en/elasticsearch/reference/current/vm-max-map-count.html</a></p>
</li>
<li>
<p>For more information about how the profiles are applied to nodes, see <a href="https://docs.openshift.com/container-platform/4.10/scalability_and_performance/using-node-tuning-operator.html#custom-tuning-specification_node-tuning-operator">Custom tuning specification</a>.</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="assembly-installing-the-core-components-of-stf_assembly">Installing the core components of Service&#160;Telemetry&#160;Framework</h2>
<div class="sectionbody">
<div class="paragraph _abstract">
<p>You can use Operators to load the Service&#160;Telemetry&#160;Framework (STF) components and objects. Operators manage each of the following STF core and community components:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>cert-manager</p>
</li>
<li>
<p>Apache&#160;Qpid&#160;Dispatch&#160;Router</p>
</li>
<li>
<p>Smart Gateway</p>
</li>
<li>
<p>Prometheus and AlertManager</p>
</li>
<li>
<p>Elasticsearch</p>
</li>
<li>
<p>Grafana</p>
</li>
</ul>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>OpenShift version 4.10 is running.</p>
</li>
<li>
<p>You have prepared your OpenShift environment and ensured that there is persistent storage and enough resources to run the STF components on top of the OpenShift environment. For more information, see <a href="https://access.redhat.com/articles/4907241">Service Telemetry Framework Performance and Scaling</a>.</p>
</li>
<li>
<p>Your environment is fully connected. STF does not work in a OpenShift-disconnected environments or network proxy environments.</p>
</li>
</ul>
</div>
<div class="ulist">
<div class="title">Additional resources</div>
<ul>
<li>
<p>For more information about Operators, see the <a href="https://docs.openshift.com/container-platform/4.10/operators/understanding/olm-what-operators-are.html"><em>Understanding Operators</em></a> guide.</p>
</li>
<li>
<p>For more information about how to remove STF from the OpenShift environment, see <a href="#assembly-removing-stf-from-the-openshift-environment_assembly">[assembly-removing-stf-from-the-openshift-environment_assembly]</a>.</p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="deploying-stf-to-the-openshift-environment_assembly-installing-the-core-components-of-stf">Deploying Service&#160;Telemetry&#160;Framework to the OpenShift environment</h3>
<div class="paragraph _abstract">
<p>Deploy Service&#160;Telemetry&#160;Framework (STF) to collect, store, and monitor events:</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Create a namespace to contain the STF components, for example, <code>service-telemetry</code>:</p>
<div class="listingblock white-space-pre">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-bash hljs" data-lang="bash">$ oc new-project service-telemetry</code></pre>
</div>
</div>
</li>
<li>
<p>Create an OperatorGroup in the namespace so that you can schedule the Operator pods:</p>
<div class="listingblock white-space-pre">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-yaml hljs" data-lang="yaml">$ oc create -f - &lt;&lt;EOF
apiVersion: operators.coreos.com/v1
kind: OperatorGroup
metadata:
  name: service-telemetry-operator-group
  namespace: service-telemetry
spec:
  targetNamespaces:
  - service-telemetry
EOF</code></pre>
</div>
</div>
<div class="paragraph">
<p>For more information, see <a href="https://docs.openshift.com/container-platform/4.10/operators/understanding/olm/olm-understanding-operatorgroups.html">OperatorGroups</a>.</p>
</div>
</li>
<li>
<p>Before you deploy STF on OpenShift, you must enable the catalog source. Install a CatalogSource that contains the Service Telemetry Operator and the Smart Gateway Operator:</p>
<div class="listingblock white-space-pre">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-yaml hljs" data-lang="yaml">$ oc create -f - &lt;&lt;EOF
apiVersion: operators.coreos.com/v1alpha1
kind: CatalogSource
metadata:
  name: infrawatch-operators
  namespace: openshift-marketplace
spec:
  displayName: InfraWatch Operators
  image: quay.io/infrawatch-operators/infrawatch-catalog:nightly-1.5
  publisher: InfraWatch
  sourceType: grpc
  updateStrategy:
    registryPoll:
      interval: 30m
EOF</code></pre>
</div>
</div>
</li>
<li>
<p>Validate the creation of your CatalogSource:</p>
<div class="listingblock white-space-pre">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-bash hljs" data-lang="bash">$ oc get -nopenshift-marketplace catalogsource infrawatch-operators

NAME                   DISPLAY                TYPE   PUBLISHER    AGE
infrawatch-operators   InfraWatch Operators   grpc   InfraWatch   2m16s</code></pre>
</div>
</div>
</li>
<li>
<p>Validate that the Operators are available from the catalog:</p>
<div class="listingblock white-space-pre">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-bash hljs" data-lang="bash">$ oc get packagemanifests | grep InfraWatch

service-telemetry-operator                    InfraWatch Operators       7m20s
smart-gateway-operator                        InfraWatch Operators       7m20s</code></pre>
</div>
</div>
</li>
<li>
<p>Create a namespace for the cert-manager Operator:</p>
<div class="listingblock white-space-pre">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-yaml hljs" data-lang="yaml">$ oc create -f - &lt;&lt;EOF
apiVersion: project.openshift.io/v1
kind: Project
metadata:
  name: openshift-cert-manager-operator
spec:
  finalizers:
  - kubernetes
EOF</code></pre>
</div>
</div>
</li>
<li>
<p>Create an OperatorGroup for the cert-manager Operator:</p>
<div class="listingblock white-space-pre">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-yaml hljs" data-lang="yaml">$ oc create -f - &lt;&lt;EOF
apiVersion: operators.coreos.com/v1
kind: OperatorGroup
metadata:
  name: openshift-cert-manager-operator
  namespace: openshift-cert-manager-operator
spec: {}
EOF</code></pre>
</div>
</div>
</li>
<li>
<p>Subscribe to the cert-manager Operator by using the redhat-operators CatalogSource:</p>
<div class="listingblock white-space-pre">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-yaml hljs" data-lang="yaml">$ oc create -f - &lt;&lt;EOF
apiVersion: operators.coreos.com/v1alpha1
kind: Subscription
metadata:
  name: openshift-cert-manager-operator
  namespace: openshift-cert-manager-operator
spec:
  channel: tech-preview
  installPlanApproval: Automatic
  name: openshift-cert-manager-operator
  source: redhat-operators
  sourceNamespace: openshift-marketplace
EOF</code></pre>
</div>
</div>
</li>
<li>
<p>Validate your ClusterServiceVersion. Ensure that cert-manager Operator displays a phase of <code>Succeeded</code>:</p>
<div class="listingblock white-space-pre">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-bash hljs" data-lang="bash">$ oc get csv --namespace openshift-cert-manager-operator --selector=operators.coreos.com/openshift-cert-manager-operator.openshift-cert-manager-operator

NAME                            DISPLAY                                       VERSION   REPLACES   PHASE
openshift-cert-manager.v1.7.1   cert-manager Operator for Red Hat OpenShift   1.7.1-1              Succeeded</code></pre>
</div>
</div>
</li>
<li>
<p>Subscribe to the AMQ Interconnect Operator by using the redhat-operators CatalogSource:</p>
<div class="listingblock white-space-pre">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-yaml hljs" data-lang="yaml">$ oc create -f - &lt;&lt;EOF
apiVersion: operators.coreos.com/v1alpha1
kind: Subscription
metadata:
  name: amq7-interconnect-operator
  namespace: service-telemetry
spec:
  channel: 1.10.x
  installPlanApproval: Automatic
  name: amq7-interconnect-operator
  source: redhat-operators
  sourceNamespace: openshift-marketplace
EOF</code></pre>
</div>
</div>
</li>
<li>
<p>Validate your ClusterServiceVersion. Ensure that amq7-interconnect-operator.v1.10.10 displays a phase of <code>Succeeded</code>:</p>
<div class="listingblock white-space-pre">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-bash hljs" data-lang="bash">$ oc get csv --selector=operators.coreos.com/amq7-interconnect-operator.service-telemetry

NAME                                 DISPLAY                                  VERSION   REPLACES                             PHASE
amq7-interconnect-operator.v1.10.10  Red Hat Integration - AMQ Interconnect   1.10.10   amq7-interconnect-operator.v1.10.4   Succeeded</code></pre>
</div>
</div>
</li>
<li>
<p>Enable the OperatorHub.io Community Catalog Source to install data storage and visualization Operators:</p>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Red Hat supports the core Operators and workloads, including Apache&#160;Qpid&#160;Dispatch&#160;Router, Service Telemetry Operator, and Smart Gateway Operator. Red Hat does not support the community Operators or workload components, inclusive of Elasticsearch, Prometheus, Alertmanager, Grafana, and their Operators.
</td>
</tr>
</table>
</div>
<div class="listingblock white-space-pre">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-yaml hljs" data-lang="yaml">$ oc create -f - &lt;&lt;EOF
apiVersion: operators.coreos.com/v1alpha1
kind: CatalogSource
metadata:
  name: operatorhubio-operators
  namespace: openshift-marketplace
spec:
  sourceType: grpc
  image: quay.io/operatorhubio/catalog:latest
  displayName: OperatorHub.io Operators
  publisher: OperatorHub.io
EOF</code></pre>
</div>
</div>
</li>
<li>
<p>If you plan to store metrics in Prometheus, you must enable the Prometheus Operator. To enable the Prometheus Operator, create the following manifest in your OpenShift environment:</p>
<div class="listingblock white-space-pre">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-yaml hljs" data-lang="yaml">$ oc create -f - &lt;&lt;EOF
apiVersion: operators.coreos.com/v1alpha1
kind: Subscription
metadata:
  name: prometheus
  namespace: service-telemetry
spec:
  channel: beta
  installPlanApproval: Automatic
  name: prometheus
  source: operatorhubio-operators
  sourceNamespace: openshift-marketplace
EOF</code></pre>
</div>
</div>
</li>
<li>
<p>Verify that the ClusterServiceVersion for Prometheus <code>Succeeded</code>:</p>
<div class="listingblock white-space-pre">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-bash hljs" data-lang="bash">$ oc get csv --selector=operators.coreos.com/prometheus.service-telemetry

NAME                        DISPLAY               VERSION   REPLACES                    PHASE
prometheusoperator.0.47.0   Prometheus Operator   0.47.0    prometheusoperator.0.37.0   Succeeded</code></pre>
</div>
</div>
</li>
<li>
<p>If you plan to store events in Elasticsearch, you must enable the Elastic Cloud on Kubernetes (ECK) Operator. To enable the ECK Operator, create the following manifest in your OpenShift environment:</p>
<div class="listingblock white-space-pre">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-yaml hljs" data-lang="yaml">$ oc create -f - &lt;&lt;EOF
apiVersion: operators.coreos.com/v1alpha1
kind: Subscription
metadata:
  name: elasticsearch-eck-operator-certified
  namespace: service-telemetry
spec:
  channel: stable
  installPlanApproval: Automatic
  name: elasticsearch-eck-operator-certified
  source: certified-operators
  sourceNamespace: openshift-marketplace
EOF</code></pre>
</div>
</div>
</li>
<li>
<p>Verify that the ClusterServiceVersion for Elastic Cloud on Kubernetes <code>Succeeded</code>:</p>
<div class="listingblock white-space-pre">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-bash hljs" data-lang="bash">$ oc get csv --selector=operators.coreos.com/elasticsearch-eck-operator-certified.service-telemetry

NAME                                         DISPLAY                        VERSION   REPLACES   PHASE
elasticsearch-eck-operator-certified.v2.4.0   Elasticsearch (ECK) Operator   2.4.0     elasticsearch-eck-operator-certified.v2.3.0   Succeeded</code></pre>
</div>
</div>
</li>
<li>
<p>Create the Smart Gateway Operator subscription to manage the smartgateway instances:</p>
<div class="listingblock white-space-pre">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-yaml hljs" data-lang="yaml">$ oc create -f - &lt;&lt;EOF
apiVersion: operators.coreos.com/v1alpha1
kind: Subscription
metadata:
  name: smart-gateway-operator
  namespace: service-telemetry
spec:
  channel: stable-1.5
  installPlanApproval: Automatic
  name: smart-gateway-operator
  source: infrawatch-operators
  sourceNamespace: openshift-marketplace
EOF</code></pre>
</div>
</div>
</li>
<li>
<p>Create the Service Telemetry Operator subscription to manage the STF instances:</p>
<div class="listingblock white-space-pre">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-yaml hljs" data-lang="yaml">$ oc create -f - &lt;&lt;EOF
apiVersion: operators.coreos.com/v1alpha1
kind: Subscription
metadata:
  name: service-telemetry-operator
  namespace: service-telemetry
spec:
  channel: stable-1.5
  installPlanApproval: Automatic
  name: service-telemetry-operator
  source: infrawatch-operators
  sourceNamespace: openshift-marketplace
EOF</code></pre>
</div>
</div>
</li>
<li>
<p>Validate the Service Telemetry Operator and the dependent operators:</p>
<div class="listingblock white-space-pre">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-bash hljs" data-lang="bash">$ oc get csv --namespace service-telemetry

NAME                                         DISPLAY                                         VERSION        REPLACES                             PHASE
amq7-interconnect-operator.v1.10.10          Red Hat Integration - AMQ Interconnect          1.10.10        amq7-interconnect-operator.v1.10.4   Succeeded
elasticsearch-eck-operator-certified.v2.4.0  Elasticsearch (ECK) Operator                    2.4.0          elasticsearch-eck-operator-certified.v2.3.0   Succeeded
openshift-cert-manager.v1.7.1                 cert-manager Operator for Red Hat OpenShift   1.7.1-1                                                        Succeeded
prometheusoperator.0.47.0                    Prometheus Operator                             0.47.0         prometheusoperator.0.37.0            Succeeded
service-telemetry-operator.v1.5.1664298822   Service Telemetry Operator                      1.5.1664298822                                      Succeeded
smart-gateway-operator.v5.0.1664298817       Smart Gateway Operator                          5.0.1664298817                                      Succeeded</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="creating-a-servicetelemetry-object-in-openshift_assembly-installing-the-core-components-of-stf">Creating a ServiceTelemetry object in OpenShift</h3>
<div class="paragraph _abstract">
<p>Create a <code>ServiceTelemetry</code> object in OpenShift to result in the Service Telemetry Operator creating the supporting components for a Service&#160;Telemetry&#160;Framework (STF) deployment. For more information, see <a href="#primary-parameters-of-the-servicetelemetry-object_assembly-installing-the-core-components-of-stf">Primary parameters of the ServiceTelemetry object</a>.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>To create a <code>ServiceTelemetry</code> object that results in an STF deployment that uses the default values, create a <code>ServiceTelemetry</code> object with an empty <code>spec</code> parameter:</p>
<div class="listingblock white-space-pre">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-yaml hljs" data-lang="yaml">$ oc apply -f - &lt;&lt;EOF
apiVersion: infra.watch/v1beta1
kind: ServiceTelemetry
metadata:
  name: default
  namespace: service-telemetry
spec: {}
EOF</code></pre>
</div>
</div>
<div class="paragraph">
<p>To override a default value, define the parameter that you want to override. In this example, enable Elasticsearch by setting <code>enabled</code> to <code>true</code>:</p>
</div>
<div class="listingblock white-space-pre">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-yaml hljs" data-lang="yaml">$ oc apply -f - &lt;&lt;EOF
apiVersion: infra.watch/v1beta1
kind: ServiceTelemetry
metadata:
  name: default
  namespace: service-telemetry
spec:
  backends:
    events:
      elasticsearch:
        enabled: true
EOF</code></pre>
</div>
</div>
<div class="paragraph">
<p>Creating a <code>ServiceTelemetry</code> object with an empty <code>spec</code> parameter results in an STF deployment with the following default settings:</p>
</div>
<div class="listingblock white-space-pre">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-yaml hljs" data-lang="yaml">apiVersion: infra.watch/v1beta1
kind: ServiceTelemetry
metadata:
  name: default
  namespace: service-telemetry
spec:
  alerting:
    alertmanager:
      receivers:
        snmpTraps:
          enabled: false
          target: 192.168.24.254
      storage:
        persistent:
          pvcStorageRequest: 20G
        strategy: persistent
    enabled: true
  backends:
    events:
      elasticsearch:
        enabled: false
        storage:
          persistent:
            pvcStorageRequest: 20Gi
          strategy: persistent
        version: 7.16.1
    logs:
      loki:
        enabled: false
        flavor: 1x.extra-small
        replicationFactor: 1
        storage:
          objectStorageSecret: test
          storageClass: standard
    metrics:
      prometheus:
        enabled: true
        scrapeInterval: 10s
        storage:
          persistent:
            pvcStorageRequest: 20G
          retention: 24h
          strategy: persistent
  clouds:
  - events:
      collectors:
      - collectorType: collectd
        debugEnabled: false
        subscriptionAddress: collectd/cloud1-notify
      - collectorType: ceilometer
        debugEnabled: false
        subscriptionAddress: anycast/ceilometer/cloud1-event.sample
    metrics:
      collectors:
      - collectorType: collectd
        debugEnabled: false
        subscriptionAddress: collectd/cloud1-telemetry
      - collectorType: ceilometer
        debugEnabled: false
        subscriptionAddress: anycast/ceilometer/cloud1-metering.sample
      - collectorType: sensubility
        debugEnabled: false
        subscriptionAddress: sensubility/cloud1-telemetry
    name: cloud1
  graphing:
    enabled: false
    grafana:
      adminPassword: secret
      adminUser: root
      baseImage: docker.io/grafana/grafana:latest
      disableSignoutMenu: false
      ingressEnabled: false
  highAvailability:
    enabled: false
  observabilityStrategy: use_community
  transports:
    qdr:
      enabled: true
      web:
        enabled: false</code></pre>
</div>
</div>
<div class="paragraph">
<p>To override these defaults, add the configuration to the <code>spec</code> parameter.</p>
</div>
</li>
<li>
<p>View the STF deployment logs in the Service Telemetry Operator:</p>
<div class="listingblock white-space-pre">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-bash hljs" data-lang="bash">$ oc logs --selector name=service-telemetry-operator

...
--------------------------- Ansible Task Status Event StdOut  -----------------

PLAY RECAP *********************************************************************
localhost                  : ok=90   changed=0    unreachable=0    failed=0    skipped=26   rescued=0    ignored=0</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="ulist">
<div class="title">Verification</div>
<ul>
<li>
<p>To determine that all workloads are operating correctly, view the pods and the status of each pod.</p>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If you set the <code>backends.events.elasticsearch.enabled</code> parameter to <code>true</code>, the notification Smart Gateways report <code>Error</code> and <code>CrashLoopBackOff</code> error messages for a period of time before Elasticsearch starts.
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-bash hljs" data-lang="bash">$ oc get pods

NAME                                                      READY   STATUS    RESTARTS   AGE
alertmanager-default-0                                    2/2     Running   0          17m
default-cloud1-ceil-meter-smartgateway-6484b98b68-vd48z   2/2     Running   0          17m
default-cloud1-coll-meter-smartgateway-799f687658-4gxpn   2/2     Running   0          17m
default-cloud1-sens-meter-smartgateway-c7f4f7fc8-c57b4    2/2     Running   0          17m
default-interconnect-54658f5d4-pzrpt                      1/1     Running   0          17m
elastic-operator-66b7bc49c4-sxkc2                         1/1     Running   0          52m
interconnect-operator-69df6b9cb6-7hhp9                    1/1     Running   0          50m
prometheus-default-0                                      2/2     Running   1          17m
prometheus-operator-6458b74d86-wbdqp                      1/1     Running   0          51m
service-telemetry-operator-864646787c-hd9pm               1/1     Running   0          51m
smart-gateway-operator-79778cf548-mz5z7                   1/1     Running   0          51m</code></pre>
</div>
</div>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="primary-parameters-of-the-servicetelemetry-object_assembly-installing-the-core-components-of-stf">Primary parameters of the ServiceTelemetry object</h4>
<div class="paragraph _abstract">
<p>The <code>ServiceTelemetry</code> object comprises the following primary configuration parameters:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>alerting</code></p>
</li>
<li>
<p><code>backends</code></p>
</li>
<li>
<p><code>clouds</code></p>
</li>
<li>
<p><code>graphing</code></p>
</li>
<li>
<p><code>highAvailability</code></p>
</li>
<li>
<p><code>transports</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>You can configure each of these configuration parameters to provide different features in an STF deployment.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Support for <code>servicetelemetry.infra.watch/v1alpha1</code> was removed from STF 1.3.</p>
</div>
</td>
</tr>
</table>
</div>
<h5 id="backends_assembly-installing-the-core-components-of-stf" class="discrete">The backends parameter</h5>
<div class="paragraph">
<p>Use the <code>backends</code> parameter to control which storage back ends are available for storage of metrics and events, and to control the enablement of Smart Gateways that the <code>clouds</code> parameter defines. For more information, see <a href="#clouds_assembly-installing-the-core-components-of-stf">The clouds parameter</a>.</p>
</div>
<div class="paragraph">
<p>Currently, you can use Prometheus as the metrics storage back end and Elasticsearch as the events storage back end.</p>
</div>
<h6 id="_enabling_prometheus_as_a_storage_back_end_for_metrics" class="discrete">Enabling Prometheus as a storage back end for metrics</h6>
<div class="paragraph">
<p>To enable Prometheus as a storage back end for metrics, you must configure the <code>ServiceTelemetry</code> object.</p>
</div>
<div class="ulist">
<div class="title">Procedure</div>
<ul>
<li>
<p>Configure the <code>ServiceTelemetry</code> object:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: infra.watch/v1beta1
kind: ServiceTelemetry
metadata:
  name: default
  namespace: service-telemetry
spec:
  backends:
    metrics:
      prometheus:
        enabled: true</code></pre>
</div>
</div>
</li>
</ul>
</div>
<h6 id="backends-configuring-persistent-storage-for-prometheus_assembly-installing-the-core-components-of-stf" class="discrete">Configuring persistent storage for Prometheus</h6>
<div class="paragraph">
<p>Use the additional parameters that are defined in <code>backends.metrics.prometheus.storage.persistent</code> to configure persistent storage options for Prometheus, such as storage class and volume size.</p>
</div>
<div class="paragraph">
<p>Use <code>storageClass</code> to define the back end storage class. If you do not set this parameter, the Service Telemetry Operator uses the default storage class for the OpenShift cluster.</p>
</div>
<div class="paragraph">
<p>Use the <code>pvcStorageRequest</code> parameter to define the minimum required volume size to satisfy the storage request. If volumes are statically defined, it is possible that a volume size larger than requested is used. By default, Service Telemetry Operator requests a volume size of <code>20G</code> (20 Gigabytes).</p>
</div>
<div class="ulist">
<div class="title">Procedure</div>
<ul>
<li>
<p>List the available storage classes:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-bash hljs" data-lang="bash">$ oc get storageclasses
NAME                 PROVISIONER                RECLAIMPOLICY   VOLUMEBINDINGMODE      ALLOWVOLUMEEXPANSION   AGE
csi-manila-ceph      manila.csi.openstack.org   Delete          Immediate              false                  20h
standard (default)   kubernetes.io/cinder       Delete          WaitForFirstConsumer   true                   20h
standard-csi         cinder.csi.openstack.org   Delete          WaitForFirstConsumer   true                   20h</code></pre>
</div>
</div>
</li>
<li>
<p>Configure the <code>ServiceTelemetry</code> object:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: infra.watch/v1beta1
kind: ServiceTelemetry
metadata:
  name: default
  namespace: service-telemetry
spec:
  backends:
    metrics:
      prometheus:
        enabled: true
        storage:
          strategy: persistent
          persistent:
            storageClass: standard-csi
            pvcStorageRequest: 50G</code></pre>
</div>
</div>
</li>
</ul>
</div>
<h6 id="_enabling_elasticsearch_as_a_storage_back_end_for_events" class="discrete">Enabling Elasticsearch as a storage back end for events</h6>
<div class="paragraph">
<p>To enable Elasticsearch as a storage back end for events, you must configure the <code>ServiceTelemetry</code> object.</p>
</div>
<div class="ulist">
<div class="title">Procedure</div>
<ul>
<li>
<p>Configure the <code>ServiceTelemetry</code> object:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: infra.watch/v1beta1
kind: ServiceTelemetry
metadata:
  name: default
  namespace: service-telemetry
spec:
  backends:
    events:
      elasticsearch:
        enabled: true</code></pre>
</div>
</div>
</li>
</ul>
</div>
<h6 id="backends-configuring-persistent-storage-for-elasticsearch_assembly-installing-the-core-components-of-stf" class="discrete">Configuring persistent storage for Elasticsearch</h6>
<div class="paragraph">
<p>Use the additional parameters defined in <code>backends.events.elasticsearch.storage.persistent</code> to configure persistent storage options for Elasticsearch, such as storage class and volume size.</p>
</div>
<div class="paragraph">
<p>Use <code>storageClass</code> to define the back end storage class. If you do not set this parameter, the Service Telemetry Operator uses the default storage class for the OpenShift cluster.</p>
</div>
<div class="paragraph">
<p>Use the <code>pvcStorageRequest</code> parameter to define the minimum required volume size to satisfy the storage request. If volumes are statically defined, it is possible that a volume size larger than requested is used. By default, Service Telemetry Operator requests a volume size of <code>20Gi</code> (20 Gibibytes).</p>
</div>
<div class="ulist">
<div class="title">Procedure</div>
<ul>
<li>
<p>List the available storage classes:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-bash hljs" data-lang="bash">$ oc get storageclasses
NAME                 PROVISIONER                RECLAIMPOLICY   VOLUMEBINDINGMODE      ALLOWVOLUMEEXPANSION   AGE
csi-manila-ceph      manila.csi.openstack.org   Delete          Immediate              false                  20h
standard (default)   kubernetes.io/cinder       Delete          WaitForFirstConsumer   true                   20h
standard-csi         cinder.csi.openstack.org   Delete          WaitForFirstConsumer   true                   20h</code></pre>
</div>
</div>
</li>
<li>
<p>Configure the <code>ServiceTelemetry</code> object:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: infra.watch/v1beta1
kind: ServiceTelemetry
metadata:
  name: default
  namespace: service-telemetry
spec:
  backends:
    events:
      elasticsearch:
        enabled: true
        version: 7.16.1
        storage:
          strategy: persistent
          persistent:
            storageClass: standard-csi
            pvcStorageRequest: 50G</code></pre>
</div>
</div>
</li>
</ul>
</div>
<h5 id="clouds_assembly-installing-the-core-components-of-stf" class="discrete">The clouds parameter</h5>
<div class="paragraph">
<p>Use the <code>clouds</code> parameter to define which Smart Gateway objects deploy, thereby providing the interface for multiple monitored cloud environments to connect to an instance of STF. If a supporting back end is available, then metrics and events Smart Gateways for the default cloud configuration are created. By default, the Service Telemetry Operator creates Smart Gateways for <code>cloud1</code>.</p>
</div>
<div class="paragraph">
<p>You can create a list of cloud objects to control which Smart Gateways are created for the defined clouds. Each cloud consists of data types and collectors. Data types are <code>metrics</code> or <code>events</code>. Each data type consists of a list of collectors, the message bus subscription address, and a parameter to enable debugging. Available collectors for metrics are <code>collectd</code>, <code>ceilometer</code>, and <code>sensubility</code>. Available collectors for events are <code>collectd</code> and <code>ceilometer</code>. Ensure that the subscription address for each of these collectors is unique for every cloud, data type, and collector combination.</p>
</div>
<div class="paragraph">
<p>The default <code>cloud1</code> configuration is represented by the following <code>ServiceTelemetry</code> object, which provides subscriptions and data storage of metrics and events for collectd, Ceilometer, and Sensubility data collectors for a particular cloud instance:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: infra.watch/v1beta1
kind: ServiceTelemetry
metadata:
  name: stf-default
  namespace: service-telemetry
spec:
  clouds:
    - name: cloud1
      metrics:
        collectors:
          - collectorType: collectd
            subscriptionAddress: collectd/telemetry
          - collectorType: ceilometer
            subscriptionAddress: anycast/ceilometer/metering.sample
          - collectorType: sensubility
            subscriptionAddress: sensubility/telemetry
            debugEnabled: false
      events:
        collectors:
          - collectorType: collectd
            subscriptionAddress: collectd/notify
          - collectorType: ceilometer
            subscriptionAddress: anycast/ceilometer/event.sample</code></pre>
</div>
</div>
<div class="paragraph">
<p>Each item of the <code>clouds</code> parameter represents a cloud instance. A cloud instance consists of three top-level parameters: <code>name</code>, <code>metrics</code>, and <code>events</code>. The <code>metrics</code> and <code>events</code> parameters represent the corresponding back end for storage of that data type. The <code>collectors</code> parameter specifies a list of objects made up of two required parameters, <code>collectorType</code> and <code>subscriptionAddress</code>, and these represent an instance of the Smart Gateway. The <code>collectorType</code> parameter specifies data collected by either collectd, Ceilometer, or Sensubility. The <code>subscriptionAddress</code> parameter provides the Apache&#160;Qpid&#160;Dispatch&#160;Router address to which a Smart Gateway subscribes.</p>
</div>
<div class="paragraph">
<p>You can use the optional Boolean parameter <code>debugEnabled</code> within the <code>collectors</code> parameter to enable additional console debugging in the running Smart Gateway pod.</p>
</div>
<div class="ulist">
<div class="title">Additional resources</div>
<ul>
<li>
<p>For more information about deleting default Smart Gateways, see <a href="#deleting-the-default-smart-gateways_assembly-completing-the-stf-configuration">Deleting the default Smart Gateways</a>.</p>
</li>
<li>
<p>For more information about how to configure multiple clouds, see <a href="#configuring-multiple-clouds_assembly-completing-the-stf-configuration">Configuring multiple clouds</a>.</p>
</li>
</ul>
</div>
<h5 id="alerting_assembly-installing-the-core-components-of-stf" class="discrete">The alerting parameter</h5>
<div class="paragraph">
<p>Use the <code>alerting</code> parameter to control creation of an Alertmanager instance and the configuration of the storage back end. By default, <code>alerting</code> is enabled. For more information, see <a href="#alerts_assembly-advanced-features">Alerts in Service&#160;Telemetry&#160;Framework</a>.</p>
</div>
<h5 id="graphing_assembly-installing-the-core-components-of-stf" class="discrete">The graphing parameter</h5>
<div class="paragraph">
<p>Use the <code>graphing</code> parameter to control the creation of a Grafana instance. By default, <code>graphing</code> is disabled. For more information, see <a href="#dashboards_assembly-advanced-features">Dashboards in Service&#160;Telemetry&#160;Framework</a>.</p>
</div>
<h5 id="highAvailability_assembly-installing-the-core-components-of-stf" class="discrete">The highAvailability parameter</h5>
<div class="paragraph">
<p>Use the <code>highAvailability</code> parameter to control the instantiation of multiple copies of STF components to reduce recovery time of components that fail or are rescheduled. By default, <code>highAvailability</code> is disabled. For more information, see <a href="#high-availability_assembly-advanced-features">High availability</a>.</p>
</div>
<h5 id="transports_assembly-installing-the-core-components-of-stf" class="discrete">The transports parameter</h5>
<div class="paragraph">
<p>Use the <code>transports</code> parameter to control the enablement of the message bus for a STF deployment. The only transport currently supported is Apache&#160;Qpid&#160;Dispatch&#160;Router. By default, the <code>qdr</code> transport is enabled.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="accessing-uis-for-stf-components_assembly-installing-the-core-components-of-stf">Accessing user interfaces for STF components</h3>
<div class="paragraph _abstract">
<p>In OpenShift, applications are exposed to the external network through a route. For more information about routes, see <a href="https://docs.openshift.com/container-platform/4.10/networking/configuring_ingress_cluster_traffic/overview-traffic.html">Configuring ingress cluster traffic</a>.</p>
</div>
<div class="paragraph">
<p>In Service&#160;Telemetry&#160;Framework (STF), HTTPS routes are exposed for each service that has a web-based interface. These routes are protected by OpenShift RBAC and any user that has a <code>ClusterRoleBinding</code> that enables them to view OpenShift Namespaces can log in. For more information about RBAC, see <a href="https://docs.openshift.com/container-platform/4.10/authentication/using-rbac.html">Using RBAC to define and apply permissions</a>.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Log in to OpenShift.</p>
</li>
<li>
<p>Change to the <code>service-telemetry</code> namespace:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">$ oc project service-telemetry</code></pre>
</div>
</div>
</li>
<li>
<p>List the available web UI routes in the <code>service-telemetry</code> project:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-bash hljs" data-lang="bash">$ oc get routes | grep web
default-alertmanager-proxy   default-alertmanager-proxy-service-telemetry.apps.infra.watch          default-alertmanager-proxy   web     reencrypt/Redirect   None
default-prometheus-proxy     default-prometheus-proxy-service-telemetry.apps.infra.watch            default-prometheus-proxy     web     reencrypt/Redirect   None</code></pre>
</div>
</div>
</li>
<li>
<p>In a web browser, navigate to <a href="https://&lt;route_address&gt" class="bare">https://&lt;route_address&gt</a>; to access the web interface for the corresponding service.</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="configuring-observability-strategy_assembly-installing-the-core-components-of-stf">Configuring an alternate observability strategy</h3>
<div class="paragraph _abstract">
<p>To configure STF to skip the deployment of storage, visualization, and alerting backends, add <code>observabilityStrategy: none</code> to the ServiceTelemetry spec. In this mode, only Apache&#160;Qpid&#160;Dispatch&#160;Router routers and metrics Smart Gateways are deployed, and you must configure an external Prometheus-compatible system to collect metrics from the STF Smart Gateways.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Currently, only metrics are supported when you set <code>observabilityStrategy</code> to <code>none</code>.  Events Smart Gateways are not deployed.
</td>
</tr>
</table>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Create a <code>ServiceTelemetry</code> object with the property <code>observabilityStrategy: none</code> in the <code>spec</code> parameter. The manifest shows results in a default deployment of STF that is suitable for receiving telemetry from a single cloud with all metrics collector types.</p>
<div class="listingblock white-space-pre">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-yaml hljs" data-lang="yaml">$ oc apply -f - &lt;&lt;EOF
apiVersion: infra.watch/v1beta1
kind: ServiceTelemetry
metadata:
  name: default
  namespace: service-telemetry
spec:
  observabilityStrategy: none
EOF</code></pre>
</div>
</div>
</li>
<li>
<p>To verify that all workloads are operating correctly, view the pods and the status of each pod:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-bash hljs" data-lang="bash">$ oc get pods
NAME                                                      READY   STATUS    RESTARTS   AGE
default-cloud1-ceil-meter-smartgateway-59c845d65b-gzhcs   3/3     Running   0          132m
default-cloud1-coll-meter-smartgateway-75bbd948b9-d5phm   3/3     Running   0          132m
default-cloud1-sens-meter-smartgateway-7fdbb57b6d-dh2g9   3/3     Running   0          132m
default-interconnect-668d5bbcd6-57b2l                     1/1     Running   0          132m
interconnect-operator-b8f5bb647-tlp5t                     1/1     Running   0          47h
service-telemetry-operator-566b9dd695-wkvjq               1/1     Running   0          156m
smart-gateway-operator-58d77dcf7-6xsq7                    1/1     Running   0          47h</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<div class="title">Additional resources</div>
<p>For more information about configuring additional clouds or to change the set of supported collectors, see <a href="#deploying-smart-gateways_assembly-completing-the-stf-configuration">Deploying Smart Gateways</a></p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="assembly-completing-the-stf-configuration_assembly">Configuring OpenStack for Service&#160;Telemetry&#160;Framework</h2>
<div class="sectionbody">
<div class="paragraph _abstract">
<p>To collect metrics, events, or both, and to send them to the Service&#160;Telemetry&#160;Framework (STF) storage domain, you must configure the OpenStack (OSP) overcloud to enable data collection and transport.</p>
</div>
<div class="paragraph">
<p>STF can support both single and multiple clouds. The default configuration in OSP and STF set up for a single cloud installation.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>For a single OSP overcloud deployment with default configuration, see <a href="#configuring-red-hat-openstack-platform-overcloud-for-stf_assembly-completing-the-stf-configuration">Deploying OpenStack overcloud for Service&#160;Telemetry&#160;Framework</a>.</p>
</li>
<li>
<p>To plan your OSP installation and configuration STF for multiple clouds, see <a href="#configuring-multiple-clouds_assembly-completing-the-stf-configuration">Configuring multiple clouds</a>.</p>
</li>
<li>
<p>As part of an OSP overcloud deployment, you might need to configure additional features in your environment:</p>
<div class="ulist">
<ul>
<li>
<p>To deploy data collection and transport to STF on OSP cloud nodes that employ routed L3 domains, such as distributed compute node (DCN) or spine-leaf, see <a href="#deploying-to-non-standard-network-topologies_assembly-completing-the-stf-configuration">Deploying to non-standard network topologies</a>.</p>
</li>
<li>
<p>To send metrics to both Gnocchi and STF, see <a href="#sending-metrics-to-gnocchi-and-to-stf_assembly-completing-the-stf-configuration">Sending metrics to Gnocchi and Service&#160;Telemetry&#160;Framework</a>.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="configuring-red-hat-openstack-platform-overcloud-for-stf_assembly-completing-the-stf-configuration">Deploying OpenStack overcloud for Service&#160;Telemetry&#160;Framework</h3>
<div class="paragraph _abstract">
<p>As part of the OpenStack (OSP) overcloud deployment, you must configure the data collectors and the data transport to Service&#160;Telemetry&#160;Framework (STF).</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p><a href="#retrieving-the-qdr-route-address_assembly-completing-the-stf-configuration">Retrieving the Apache&#160;Qpid&#160;Dispatch&#160;Router route address</a></p>
</li>
<li>
<p><a href="#creating-the-base-configuration-for-stf_assembly-completing-the-stf-configuration">Creating the base configuration for STF</a></p>
</li>
<li>
<p><a href="#configuring-the-stf-connection-for-the-overcloud_assembly-completing-the-stf-configuration">Configuring the STF connection for the overcloud</a></p>
</li>
<li>
<p><a href="#deploying-the-overcloud_assembly-completing-the-stf-configuration">Deploying the overcloud</a></p>
</li>
<li>
<p><a href="#validating-clientside-installation_assembly-completing-the-stf-configuration">Validating client-side installation</a></p>
</li>
</ol>
</div>
<div class="ulist">
<div class="title">Additional resources</div>
<ul>
<li>
<p>To collect data through Apache&#160;Qpid&#160;Dispatch&#160;Router, see <a href="https://access.redhat.com/documentation/en-us/red_hat_openstack_platform/16.2/html/operational_measurements/collectd-plugins_assembly">the amqp1 plug-in</a>.</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="retrieving-the-qdr-route-address_assembly-completing-the-stf-configuration">Retrieving the Apache&#160;Qpid&#160;Dispatch&#160;Router route address</h4>
<div class="paragraph _abstract">
<p>When you configure the OpenStack (OSP) overcloud for Service&#160;Telemetry&#160;Framework (STF), you must provide the Apache&#160;Qpid&#160;Dispatch&#160;Router route address in the STF connection file.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Log in to your OpenShift environment.</p>
</li>
<li>
<p>In the <code>service-telemetry</code> project, retrieve the Apache&#160;Qpid&#160;Dispatch&#160;Router route address:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-bash hljs" data-lang="bash">$ oc get routes -ogo-template='{{ range .items }}{{printf "%s\n" .spec.host }}{{ end }}' | grep "\-5671"
default-interconnect-5671-service-telemetry.apps.infra.watch</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="creating-the-base-configuration-for-stf_assembly-completing-the-stf-configuration">Creating the base configuration for STF</h4>
<div class="paragraph _abstract">
<p>To configure the base parameters to provide a compatible data collection and transport for Service&#160;Telemetry&#160;Framework (STF), you must create a file that defines the default data collection values.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Log in to the OpenStack (OSP) undercloud as the <code>stack</code> user.</p>
</li>
<li>
<p>Create a configuration file called <code>enable-stf.yaml</code> in the <code>/home/stack</code> directory.</p>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Setting <code>EventPipelinePublishers</code> and <code>PipelinePublishers</code> to empty lists results in no event or metric data passing to OSP telemetry components, such as Gnocchi or Panko. If you need to send data to additional pipelines, the Ceilometer polling interval of 30 seconds, as specified in <code>ExtraConfig</code>, might overwhelm the OSP telemetry components, and you must increase the interval to a larger value, such as <code>300</code>. Increasing the value to a longer polling interval results in less telemetry resolution in STF.</p>
</div>
<div class="paragraph">
<p>To enable collection of telemetry with STF and Gnocchi, see <a href="#sending-metrics-to-gnocchi-and-to-stf_assembly-completing-the-stf-configuration">Sending metrics to Gnocchi and Service&#160;Telemetry&#160;Framework</a></p>
</div>
</td>
</tr>
</table>
</div>
</li>
</ol>
</div>
<div class="listingblock">
<div class="title">enable-stf.yaml</div>
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-yaml hljs" data-lang="yaml">parameter_defaults:
    # only send to STF, not other publishers
    EventPipelinePublishers: []
    PipelinePublishers: []

    # manage the polling and pipeline configuration files for Ceilometer agents
    ManagePolling: true
    ManagePipeline: true

    # enable Ceilometer metrics and events
    CeilometerQdrPublishMetrics: true
    CeilometerQdrPublishEvents: true

    # enable collection of API status
    CollectdEnableSensubility: true
    CollectdSensubilityTransport: amqp1

    # enable collection of containerized service metrics
    CollectdEnableLibpodstats: true

    # set collectd overrides for higher telemetry resolution and extra plugins
    # to load
    CollectdConnectionType: amqp1
    CollectdAmqpInterval: 5
    CollectdDefaultPollingInterval: 5
    CollectdExtraPlugins:
    - vmem

    # set standard prefixes for where metrics and events are published to QDR
    MetricsQdrAddresses:
    - prefix: 'collectd'
      distribution: multicast
    - prefix: 'anycast/ceilometer'
      distribution: multicast

    ExtraConfig:
        ceilometer::agent::polling::polling_interval: 30
        ceilometer::agent::polling::polling_meters:
        - cpu
        - disk.*
        - ip.*
        - image.*
        - memory
        - memory.*
        - network.*
        - perf.*
        - port
        - port.*
        - switch
        - switch.*
        - storage.*
        - volume.*

        # to avoid filling the memory buffers if disconnected from the message bus
        # note: this may need an adjustment if there are many metrics to be sent.
        collectd::plugin::amqp1::send_queue_limit: 5000

        # receive extra information about virtual memory
        collectd::plugin::vmem::verbose: true

        # provide name and uuid in addition to hostname for better correlation
        # to ceilometer data
        collectd::plugin::virt::hostname_format: "name uuid hostname"

        # provide the human-friendly name of the virtual instance
        collectd::plugin::virt::plugin_instance_format: metadata

        # set memcached collectd plugin to report its metrics by hostname
        # rather than host IP, ensuring metrics in the dashboard remain uniform
        collectd::plugin::memcached::instances:
          local:
            host: "%{hiera('fqdn_canonical')}"
            port: 11211</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="configuring-the-stf-connection-for-the-overcloud_assembly-completing-the-stf-configuration">Configuring the STF connection for the overcloud</h4>
<div class="paragraph _abstract">
<p>To configure the Service&#160;Telemetry&#160;Framework (STF) connection, you must create a file that contains the connection configuration of the Apache&#160;Qpid&#160;Dispatch&#160;Router for the overcloud to the STF deployment. Enable the collection of events and storage of the events in STF and deploy the overcloud. The default configuration is for a single cloud instance with the default message bus topics. For configuration of multiple cloud deployments, see <a href="#configuring-multiple-clouds_assembly-completing-the-stf-configuration">Configuring multiple clouds</a>.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>Retrieve the Apache&#160;Qpid&#160;Dispatch&#160;Router route address. For more information, see <a href="#retrieving-the-qdr-route-address_assembly-completing-the-stf-configuration">Retrieving the Apache&#160;Qpid&#160;Dispatch&#160;Router route address</a>.</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Log in to the OSP undercloud as the <code>stack</code> user.</p>
</li>
<li>
<p>Create a configuration file called <code>stf-connectors.yaml</code> in the <code>/home/stack</code> directory.</p>
</li>
<li>
<p>In the <code>stf-connectors.yaml</code> file, configure the <code>MetricsQdrConnectors</code> address to connect the Apache&#160;Qpid&#160;Dispatch&#160;Router on the overcloud to the STF deployment. You configure the topic addresses for Sensubility, Ceilometer, and collectd in this file to match the defaults in STF. For more information about customizing topics and cloud configuration, see <a href="#configuring-multiple-clouds_assembly-completing-the-stf-configuration">Configuring multiple clouds</a>.</p>
<div class="ulist">
<ul>
<li>
<p>The <code>resource_registry</code> configuration directly loads the collectd service because you do not include the <code>collectd-write-qdr.yaml</code> environment file for multiple cloud deployments.</p>
</li>
<li>
<p>Replace the <code>host</code> parameter with the value of <code>HOST/PORT</code> that you retrieved in <a href="#retrieving-the-qdr-route-address_assembly-completing-the-stf-configuration">Retrieving the Apache&#160;Qpid&#160;Dispatch&#160;Router route address</a>.</p>
</li>
<li>
<p>Replace the <code>host</code> sub-parameter of <code>MetricsQdrConnectors</code> with the value of <code>HOST/PORT</code> that you retrieved in <a href="#retrieving-the-qdr-route-address_assembly-completing-the-stf-configuration">Retrieving the Apache&#160;Qpid&#160;Dispatch&#160;Router route address</a>.</p>
</li>
<li>
<p>Set <code>CeilometerQdrEventsConfig.topic</code> to define the topic for Ceilometer events. The format of this value is <code>anycast/ceilometer/cloud1-event.sample</code>.</p>
</li>
<li>
<p>Set <code>CeilometerQdrMetricsConfig.topic</code> to define the topic for Ceilometer metrics. The format of this value is <code>anycast/ceilometer/cloud1-metering.sample</code>.</p>
</li>
<li>
<p>Set <code>CollectdAmqpInstances</code> to define the topic for collectd events. The format of this value is <code>collectd/cloud1-notify</code>.</p>
</li>
<li>
<p>Set <code>CollectdAmqpInstances</code> to define the topic for collectd metrics. The format of this value is <code>collectd/cloud1-telemetry</code>.</p>
</li>
<li>
<p>Set <code>CollectdSensubilityResultsChannel</code> to define the topic for collectd-sensubility events. The format of this value is <code>sensubility/cloud1-telemetry</code>.</p>
<div class="listingblock">
<div class="title">stf-connectors.yaml</div>
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-yaml hljs" data-lang="yaml">resource_registry:
  OS::TripleO::Services::Collectd: /usr/share/openstack-tripleo-heat-templates/deployment/metrics/collectd-container-puppet.yaml

parameter_defaults:
    MetricsQdrConnectors:
        - host: stf-default-interconnect-5671-service-telemetry.apps.infra.watch
          port: 443
          role: edge
          verifyHostname: false
          sslProfile: sslProfile

    MetricsQdrSSLProfiles:
        - name: sslProfile

    CeilometerQdrEventsConfig:
        driver: amqp
        topic: cloud1-event

    CeilometerQdrMetricsConfig:
        driver: amqp
        topic: cloud1-metering

    CollectdAmqpInstances:
        cloud1-notify:
            notify: true
            format: JSON
            presettle: false
        cloud1-telemetry:
            format: JSON
            presettle: false

    CollectdSensubilityResultsChannel: sensubility/cloud1-telemetry</code></pre>
</div>
</div>
</li>
</ul>
</div>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="deploying-the-overcloud_assembly-completing-the-stf-configuration">Deploying the overcloud</h4>
<div class="paragraph _abstract">
<p>Deploy or update the overcloud with the required environment files so that data is collected and transmitted to Service&#160;Telemetry&#160;Framework (STF).</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Log in to the OpenStack (OSP) undercloud as the <code>stack</code> user.</p>
</li>
<li>
<p>Source the authentication file:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">[stack@undercloud-0 ~]$ source stackrc

(undercloud) [stack@undercloud-0 ~]$</code></pre>
</div>
</div>
</li>
<li>
<p>Add the following files to your OSP TripleO deployment to configure data collection and Apache&#160;Qpid&#160;Dispatch&#160;Router:</p>
<div class="ulist">
<ul>
<li>
<p>The <code>ceilometer-write-qdr.yaml</code> file to ensure that Ceilometer telemetry and events are sent to STF</p>
</li>
<li>
<p>The <code>qdr-edge-only.yaml</code> file to ensure that the message bus is enabled and connected to STF message bus routers</p>
</li>
<li>
<p>The <code>enable-stf.yaml</code> environment file to ensure defaults are configured correctly</p>
</li>
<li>
<p>The <code>stf-connectors.yaml</code> environment file to define the connection to STF</p>
</li>
</ul>
</div>
</li>
<li>
<p>Deploy the OSP overcloud:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-bash hljs" data-lang="bash">(undercloud) [stack@undercloud-0 ~]$ openstack overcloud deploy <em>&lt;other_arguments&gt;</em>
--templates /usr/share/openstack-tripleo-heat-templates \
  --environment-file <em>&lt;...other_environment_files...&gt;</em> \
  --environment-file /usr/share/openstack-tripleo-heat-templates/environments/metrics/ceilometer-write-qdr.yaml \
  --environment-file /usr/share/openstack-tripleo-heat-templates/environments/metrics/qdr-edge-only.yaml \
  --environment-file /home/stack/enable-stf.yaml \
  --environment-file /home/stack/stf-connectors.yaml</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="validating-clientside-installation_assembly-completing-the-stf-configuration">Validating client-side installation</h4>
<div class="paragraph _abstract">
<p>To validate data collection from the Service&#160;Telemetry&#160;Framework (STF) storage domain, query the data sources for delivered data. To validate individual nodes in the OpenStack (OSP) deployment, use SSH to connect to the console.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Some telemetry data is available only when OSP has active workloads.
</td>
</tr>
</table>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Log in to an overcloud node, for example, controller-0.</p>
</li>
<li>
<p>Ensure that the <code>metrics_qdr</code> container is running on the node:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-bash hljs" data-lang="bash">$ sudo podman container inspect --format '{{.State.Status}}' metrics_qdr

running</code></pre>
</div>
</div>
</li>
<li>
<p>Return the internal network address on which Apache&#160;Qpid&#160;Dispatch&#160;Router is running, for example, <code>172.17.1.44</code> listening on port <code>5666</code>:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-bash hljs" data-lang="bash">$ sudo podman exec -it metrics_qdr cat /etc/qpid-dispatch/qdrouterd.conf

listener {
    host: 172.17.1.44
    port: 5666
    authenticatePeer: no
    saslMechanisms: ANONYMOUS
}</code></pre>
</div>
</div>
</li>
<li>
<p>Return a list of connections to the local Apache&#160;Qpid&#160;Dispatch&#160;Router:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-bash hljs" data-lang="bash">$ sudo podman exec -it metrics_qdr qdstat --bus=172.17.1.44:5666 --connections

Connections
  id   host                                                                  container                                                                                                  role    dir  security                            authentication  tenant
  ============================================================================================================================================================================================================================================================================================
  1    default-interconnect-5671-service-telemetry.apps.infra.watch:443      default-interconnect-7458fd4d69-bgzfb                                                                      edge    out  TLSv1.2(DHE-RSA-AES256-GCM-SHA384)  anonymous-user
  12   172.17.1.44:60290                                                     openstack.org/om/container/controller-0/ceilometer-agent-notification/25/5c02cee550f143ec9ea030db5cccba14  normal  in   no-security                         no-auth
  16   172.17.1.44:36408                                                     metrics                                                                                                    normal  in   no-security                         anonymous-user
  899  172.17.1.44:39500                                                     10a2e99d-1b8a-4329-b48c-4335e5f75c84                                                                       normal  in   no-security                         no-auth</code></pre>
</div>
</div>
<div class="paragraph">
<p>There are four connections:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Outbound connection to STF</p>
</li>
<li>
<p>Inbound connection from ceilometer</p>
</li>
<li>
<p>Inbound connection from collectd</p>
</li>
<li>
<p>Inbound connection from our <code>qdstat</code> client</p>
<div class="paragraph">
<p>The outbound STF connection is provided to the <code>MetricsQdrConnectors</code> host parameter and is the route for the STF storage domain. The other hosts are internal network addresses of the client connections to this Apache&#160;Qpid&#160;Dispatch&#160;Router.</p>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>To ensure that messages are delivered, list the links, and view the <code>_edge</code> address in the <code>deliv</code> column for delivery of messages:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-bash hljs" data-lang="bash">$ sudo podman exec -it metrics_qdr qdstat --bus=172.17.1.44:5666 --links
Router Links
  type      dir  conn id  id    peer  class   addr                  phs  cap  pri  undel  unsett  deliv    presett  psdrop  acc  rej  rel     mod  delay  rate
  ===========================================================================================================================================================
  endpoint  out  1        5           local   _edge                      250  0    0      0       2979926  0        0       0    0    2979926 0    0      0
  endpoint  in   1        6                                              250  0    0      0       0        0        0       0    0    0       0    0      0
  endpoint  in   1        7                                              250  0    0      0       0        0        0       0    0    0       0    0      0
  endpoint  out  1        8                                              250  0    0      0       0        0        0       0    0    0       0    0      0
  endpoint  in   1        9                                              250  0    0      0       0        0        0       0    0    0       0    0      0
  endpoint  out  1        10                                             250  0    0      0       911      911      0       0    0    0       0    911    0
  endpoint  in   1        11                                             250  0    0      0       0        911      0       0    0    0       0    0      0
  endpoint  out  12       32          local   temp.lSY6Mcicol4J2Kp       250  0    0      0       0        0        0       0    0    0       0    0      0
  endpoint  in   16       41                                             250  0    0      0       2979924  0        0       0    0    2979924 0    0      0
  endpoint  in   912      1834        mobile  $management           0    250  0    0      0       1        0        0       1    0    0       0    0      0
  endpoint  out  912      1835        local   temp.9Ok2resI9tmt+CT       250  0    0      0       0        0        0       0    0    0       0    0      0</code></pre>
</div>
</div>
</li>
<li>
<p>To list the addresses from OSP nodes to STF, connect to OpenShift to retrieve the Apache&#160;Qpid&#160;Dispatch&#160;Router pod name and list the connections. List the available Apache&#160;Qpid&#160;Dispatch&#160;Router pods:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">$ oc get pods -l application=default-interconnect

NAME                                    READY   STATUS    RESTARTS   AGE
default-interconnect-7458fd4d69-bgzfb   1/1     Running   0          6d21h</code></pre>
</div>
</div>
</li>
<li>
<p>Connect to the pod and list the known connections. In this example, there are three <code>edge</code> connections from the OSP nodes with connection <code>id</code> 22, 23, and 24:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-bash hljs" data-lang="bash">$ oc exec -it default-interconnect-7458fd4d69-bgzfb -- qdstat --connections

2020-04-21 18:25:47.243852 UTC
default-interconnect-7458fd4d69-bgzfb

Connections
  id  host               container                                                      role    dir  security                                authentication  tenant  last dlv      uptime
  ===============================================================================================================================================================================================
  5   10.129.0.110:48498  bridge-3f5                                                    edge    in   no-security                             anonymous-user          000:00:00:02  000:17:36:29
  6   10.129.0.111:43254  rcv[default-cloud1-ceil-meter-smartgateway-58f885c76d-xmxwn]  edge    in   no-security                             anonymous-user          000:00:00:02  000:17:36:20
  7   10.130.0.109:50518  rcv[default-cloud1-coll-event-smartgateway-58fbbd4485-rl9bd]  normal  in   no-security                             anonymous-user          -             000:17:36:11
  8   10.130.0.110:33802  rcv[default-cloud1-ceil-event-smartgateway-6cfb65478c-g5q82]  normal  in   no-security                             anonymous-user          000:01:26:18  000:17:36:05
  22  10.128.0.1:51948   Router.ceph-0.redhat.local                                     edge    in   TLSv1/SSLv3(DHE-RSA-AES256-GCM-SHA384)  anonymous-user          000:00:00:03  000:22:08:43
  23  10.128.0.1:51950   Router.compute-0.redhat.local                                  edge    in   TLSv1/SSLv3(DHE-RSA-AES256-GCM-SHA384)  anonymous-user          000:00:00:03  000:22:08:43
  24  10.128.0.1:52082   Router.controller-0.redhat.local                               edge    in   TLSv1/SSLv3(DHE-RSA-AES256-GCM-SHA384)  anonymous-user          000:00:00:00  000:22:08:34
  27  127.0.0.1:42202    c2f541c1-4c97-4b37-a189-a396c08fb079                           normal  in   no-security                             no-auth                 000:00:00:00  000:00:00:00</code></pre>
</div>
</div>
</li>
<li>
<p>To view the number of messages delivered by the network, use each address with the <code>oc exec</code> command:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-bash hljs" data-lang="bash">$ oc exec -it default-interconnect-7458fd4d69-bgzfb -- qdstat --address

2020-04-21 18:20:10.293258 UTC
default-interconnect-7458fd4d69-bgzfb

Router Addresses
  class   addr                                phs  distrib    pri  local  remote  in           out          thru  fallback
  ==========================================================================================================================
  mobile  anycast/ceilometer/event.sample     0    balanced   -    1      0       970          970          0     0
  mobile  anycast/ceilometer/metering.sample  0    balanced   -    1      0       2,344,833    2,344,833    0     0
  mobile  collectd/notify                     0    multicast  -    1      0       70           70           0     0
  mobile  collectd/telemetry                  0    multicast  -    1      0       216,128,890  216,128,890  0     0</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
</div>
<div class="sect2">
<h3 id="disabling-openstack-services-used-with-stf_assembly-completing-the-stf-configuration">Disabling OpenStack services used with Service&#160;Telemetry&#160;Framework</h3>
<div class="paragraph _abstract">
<p>Disable the services used when deploying OpenStack (OSP) and connecting it to Service&#160;Telemetry&#160;Framework (STF).  There is no removal of logs or generated configuration files as part of the disablement of the services.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Do not use this procedure when also using the <a href="#sending-metrics-to-gnocchi-and-to-stf_assembly-completing-the-stf-configuration">Sending metrics to Gnocchi and Service&#160;Telemetry&#160;Framework</a> procedure because the <code>gnocchi-connectors.yaml</code> does not contain all dependencies required. If you want to remove STF-related services on OSP, ensure that you update your environment to enable data collection and data storage dependencies.
</td>
</tr>
</table>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Log in to the OSP undercloud as the <code>stack</code> user.</p>
</li>
<li>
<p>Source the authentication file:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">[stack@undercloud-0 ~]$ source stackrc

(undercloud) [stack@undercloud-0 ~]$</code></pre>
</div>
</div>
</li>
<li>
<p>Create the <code>disable-stf.yaml</code> environment file:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-yaml hljs" data-lang="yaml">(undercloud) [stack@undercloud-0]$ cat &gt; $HOME/disable-stf.yaml &lt;&lt;EOF
---
resource_registry:
  OS::TripleO::Services::CeilometerAgentCentral: OS::Heat::None
  OS::TripleO::Services::CeilometerAgentNotification: OS::Heat::None
  OS::TripleO::Services::CeilometerAgentIpmi: OS::Heat::None
  OS::TripleO::Services::ComputeCeilometerAgent: OS::Heat::None
  OS::TripleO::Services::Redis: OS::Heat::None
  OS::TripleO::Services::Collectd: OS::Heat::None
  OS::TripleO::Services::MetricsQdr: OS::Heat::None
EOF</code></pre>
</div>
</div>
</li>
<li>
<p>Remove the following files from your OSP TripleO deployment:</p>
<div class="ulist">
<ul>
<li>
<p><code>ceilometer-write-qdr.yaml</code></p>
</li>
<li>
<p><code>qdr-edge-only.yaml</code></p>
</li>
<li>
<p><code>enable-stf.yaml</code></p>
</li>
<li>
<p><code>stf-connectors.yaml</code></p>
</li>
</ul>
</div>
</li>
<li>
<p>Update the OSP overcloud. Ensure that you use the <code>disable-stf.yaml</code> file early in the list of environment files. By adding <code>disable-stf.yaml</code> early in the list, other environment files can override the configuration that would disable the service:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-bash hljs" data-lang="bash">(undercloud) [stack@undercloud-0 ~]$ openstack overcloud deploy <em>&lt;other_arguments&gt;</em>
--templates /usr/share/openstack-tripleo-heat-templates \
  --environment-file /home/stack/disable-stf.yaml
  --environment-file <em>&lt;other_environment_files&gt;</em> \</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="sending-metrics-to-gnocchi-and-to-stf_assembly-completing-the-stf-configuration">Sending metrics to Gnocchi and Service&#160;Telemetry&#160;Framework</h3>
<div class="paragraph _abstract">
<p>To send metrics to Service&#160;Telemetry&#160;Framework (STF) and Gnocchi simultaneously, you must include an environment file in your deployment to enable an additional publisher.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
If you need to send data to additional pipelines, the Ceilometer polling interval of 30 seconds, as specified in <code>ExtraConfig</code>, might overwhelm the OSP telemetry components, and you must increase the interval to a larger value, such as <code>300</code>. Increasing the value to a longer polling interval results in less telemetry resolution in STF.
</td>
</tr>
</table>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>You have created a file that contains the connection configuration of the Apache&#160;Qpid&#160;Dispatch&#160;Router for the overcloud to STF. For more information, see <a href="#configuring-the-stf-connection-for-the-overcloud_assembly-completing-the-stf-configuration">Configuring the STF connection for the overcloud</a>.</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Create an environment file named <code>gnocchi-connectors.yaml</code> in the <code>/home/stack</code> directory.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-yaml hljs" data-lang="yaml">resource_registry:
    OS::TripleO::Services::GnocchiApi: /usr/share/openstack-tripleo-heat-templates/deployment/gnocchi/gnocchi-api-container-puppet.yaml
    OS::TripleO::Services::GnocchiMetricd: /usr/share/openstack-tripleo-heat-templates/deployment/gnocchi/gnocchi-metricd-container-puppet.yaml
    OS::TripleO::Services::GnocchiStatsd: /usr/share/openstack-tripleo-heat-templates/deployment/gnocchi/gnocchi-statsd-container-puppet.yaml
    OS::TripleO::Services::AodhApi: /usr/share/openstack-tripleo-heat-templates/deployment/aodh/aodh-api-container-puppet.yaml
    OS::TripleO::Services::AodhEvaluator: /usr/share/openstack-tripleo-heat-templates/deployment/aodh/aodh-evaluator-container-puppet.yaml
    OS::TripleO::Services::AodhNotifier: /usr/share/openstack-tripleo-heat-templates/deployment/aodh/aodh-notifier-container-puppet.yaml
    OS::TripleO::Services::AodhListener: /usr/share/openstack-tripleo-heat-templates/deployment/aodh/aodh-listener-container-puppet.yaml

parameter_defaults:
    CeilometerEnableGnocchi: true
    CeilometerEnablePanko: false
    GnocchiArchivePolicy: 'high'
    GnocchiBackend: 'rbd'
    GnocchiRbdPoolName: 'metrics'

    EventPipelinePublishers: ['gnocchi://?filter_project=service']
    PipelinePublishers: ['gnocchi://?filter_project=service']</code></pre>
</div>
</div>
</li>
<li>
<p>Add the environment file <code>gnocchi-connectors.yaml</code> to the deployment command. Replace <em>&lt;other_arguments&gt;</em> with files that are applicable to your environment.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-bash hljs" data-lang="bash">$ openstack overcloud deploy <em>&lt;other_arguments&gt;</em>
--templates /usr/share/openstack-tripleo-heat-templates \
  --environment-file <em>&lt;...other_environment_files...&gt;</em> \
  --environment-file /usr/share/openstack-tripleo-heat-templates/environments/metrics/ceilometer-write-qdr.yaml \
  --environment-file /usr/share/openstack-tripleo-heat-templates/environments/metrics/collectd-write-qdr.yaml \
  --environment-file /usr/share/openstack-tripleo-heat-templates/environments/metrics/qdr-edge-only.yaml \
  --environment-file /home/stack/enable-stf.yaml \
  --environment-file /home/stack/stf-connectors.yaml \
  --environment-file /home/stack/gnocchi-connectors.yaml</code></pre>
</div>
</div>
</li>
<li>
<p>To ensure that the configuration was successful, verify the content of the file <code>/var/lib/config-data/puppet-generated/ceilometer/etc/ceilometer/pipeline.yaml</code> on a Controller node. Ensure that the <code>publishers</code> section of the file contains information for both <code>notifier</code> and <code>Gnocchi</code>.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-yaml hljs" data-lang="yaml">sources:
    - name: meter_source
      meters:
          - "*"
      sinks:
          - meter_sink
sinks:
    - name: meter_sink
      publishers:
          - gnocchi://?filter_project=service
          - notifier://172.17.1.35:5666/?driver=amqp&amp;topic=metering</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="deploying-to-non-standard-network-topologies_assembly-completing-the-stf-configuration">Deploying to non-standard network topologies</h3>
<div class="paragraph _abstract">
<p>If your nodes are on a separate network from the default <code>InternalApi</code> network, you must make configuration adjustments so that Apache&#160;Qpid&#160;Dispatch&#160;Router can transport data to the Service&#160;Telemetry&#160;Framework (STF) server instance. This scenario is typical in a spine-leaf or a DCN topology. For more information about DCN configuration, see the <a href="https://access.redhat.com/documentation/en-us/red_hat_openstack_platform/16.2/html-single/spine_leaf_networking/">Spine Leaf Networking</a> guide.</p>
</div>
<div class="paragraph">
<p>If you use STF with OpenStack (OSP) Wallaby and plan to monitor your Ceph, Block, or Object Storage nodes, you must make configuration changes that are similar to the configuration changes that you make to the spine-leaf and DCN network configuration. To monitor Ceph nodes, use the <code>CephStorageExtraConfig</code> parameter to define which network interface to load into the Apache&#160;Qpid&#160;Dispatch&#160;Router and collectd configuration files.</p>
</div>
<div class="listingblock white-space-pre">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-yaml hljs" data-lang="yaml">CephStorageExtraConfig:
  tripleo::profile::base::metrics::collectd::amqp_host: "%{hiera('storage')}"
  tripleo::profile::base::metrics::qdr::listener_addr: "%{hiera('storage')}"
  tripleo::profile::base::ceilometer::agent::notification::notifier_host_addr: "%{hiera('storage')}"</code></pre>
</div>
</div>
<div class="paragraph">
<p>Similarly, you must specify  <code>BlockStorageExtraConfig</code> and <code>ObjectStorageExtraConfig</code> parameters if your environment uses Block and Object Storage roles.</p>
</div>
<div class="paragraph">
<p>To deploy a spine-leaf topology, you must create roles and networks, then assign those networks to the available roles. When you configure data collection and transport for STF for an OSP deployment, the default network for roles is <code>InternalApi</code>. For Ceph, Block and Object storage roles, the default network is <code>Storage</code>.
Because a spine-leaf configuration can result in different networks being assigned to different Leaf groupings and those names are typically unique, additional configuration is required in the <code>parameter_defaults</code> section of the OSP environment files.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Document which networks are available for each of the Leaf roles. For examples of network name definitions, see <a href="https://access.redhat.com/documentation/en-us/red_hat_openstack_platform/16.2/html-single/spine_leaf_networking/index#creating-a-network-data-file">Creating a network data file</a> in the <em>Spine Leaf Networking</em> guide. For more information about the creation of the Leaf groupings (roles) and assignment of the networks to those groupings, see <a href="https://access.redhat.com/documentation/en-us/red_hat_openstack_platform/16.2/html-single/spine_leaf_networking/index#creating-a-roles-data-file">Creating a roles data file</a> in the <em>Spine Leaf Networking</em> guide.</p>
</li>
<li>
<p>Add the following configuration example to the <code>ExtraConfig</code> section for each of the leaf roles. In this example,
<code>internal_api_subnet</code>
is the value defined in the <code>name_lower</code> parameter of your network definition
(with <code>_subnet</code> appended to the name for Leaf 0)
, and is the network to which the
<code>ComputeLeaf0</code>
leaf role is connected. In this case, the network identification of 0 corresponds to the Compute role for leaf 0, and represents a value that is different from the default internal API network name.</p>
<div class="paragraph">
<p>For the
<code>ComputeLeaf0</code>
leaf role, specify extra configuration to perform a hiera lookup to determine which network interface for a particular network to assign to the collectd AMQP host parameter. Perform the same configuration for the Apache&#160;Qpid&#160;Dispatch&#160;Router listener address parameter.</p>
</div>
<div class="listingblock white-space-pre">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-yaml hljs" data-lang="yaml">ComputeLeaf0ExtraConfig:
  tripleo::profile::base::metrics::collectd::amqp_host: "%{hiera('internal_api_subnet')}"
  tripleo::profile::base::metrics::qdr::listener_addr: "%{hiera('internal_api_subnet')}"</code></pre>
</div>
</div>
<div class="paragraph">
<p>Additional leaf roles typically replace <code>_subnet</code> with <code>_leafN</code>. <code>N</code> represents a unique identifier for the leaf.</p>
</div>
<div class="listingblock white-space-pre">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-yaml hljs" data-lang="yaml">ComputeLeaf1ExtraConfig:
  tripleo::profile::base::metrics::collectd::amqp_host: "%{hiera('internal_api_leaf1')}"
  tripleo::profile::base::metrics::qdr::listener_addr: "%{hiera('internal_api_leaf1')}"</code></pre>
</div>
</div>
<div class="paragraph">
<p>This example configuration is on a CephStorage leaf role:</p>
</div>
<div class="listingblock white-space-pre">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-yaml hljs" data-lang="yaml">CephStorageLeaf0ExtraConfig:
  tripleo::profile::base::metrics::collectd::amqp_host: "%{hiera('storage_subnet')}"
  tripleo::profile::base::metrics::qdr::listener_addr: "%{hiera('storage_subnet')}"</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="configuring-multiple-clouds_assembly-completing-the-stf-configuration">Configuring multiple clouds</h3>
<div class="paragraph _abstract">
<p>You can configure multiple OpenStack (OSP) clouds to target a single instance of Service&#160;Telemetry&#160;Framework (STF). When you configure multiple clouds, every cloud must send metrics and events on their own unique message bus topic. In the STF deployment, Smart Gateway instances listen on these topics to save information to the common data store. Data that is stored by the Smart Gateway in the data storage domain is filtered by using the metadata that each of Smart Gateways creates.</p>
</div>
<div id="osp-stf-multiple-clouds" class="imageblock">
<div class="content">
<img src="images/OpenStack_STF_Overview_37_0919_topology.png" alt="An example of two OSP clouds connecting to STF"/>
</div>
<div class="title">Figure 3. Two OSP clouds connect to STF</div>
</div>
<div class="paragraph">
<p>To configure the OSP overcloud for a multiple cloud scenario, complete the following tasks:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Plan the AMQP address prefixes that you want to use for each cloud. For more information, see <a href="#planning-amqp-address-prefixes_assembly-completing-the-stf-configuration">Planning AMQP address prefixes</a>.</p>
</li>
<li>
<p>Deploy metrics and events consumer Smart Gateways for each cloud to listen on the corresponding address prefixes. For more information, see <a href="#deploying-smart-gateways_assembly-completing-the-stf-configuration">Deploying Smart Gateways</a>.</p>
</li>
<li>
<p>Configure each cloud with a unique domain name. For more information, see <a href="#setting-a-unique-cloud-domain_assembly-completing-the-stf-configuration">Setting a unique cloud domain</a>.</p>
</li>
<li>
<p>Create the base configuration for STF. For more information, see <a href="#creating-the-base-configuration-for-stf_assembly-completing-the-stf-configuration">Creating the base configuration for STF</a>.</p>
</li>
<li>
<p>Configure each cloud to send its metrics and events to STF on the correct address. For more information, see <a href="#creating-openstack-environment-file-for-multiple-clouds_assembly-completing-the-stf-configuration">Creating the OpenStack environment file for multiple clouds</a>.</p>
</li>
</ol>
</div>
<div class="sect3">
<h4 id="planning-amqp-address-prefixes_assembly-completing-the-stf-configuration">Planning AMQP address prefixes</h4>
<div class="paragraph _abstract">
<p>By default, OpenStack (OSP) nodes receive data through two data collectors; collectd and Ceilometer. The collectd-sensubility plugin requires a unique address. These components send telemetry data or notifications to the respective AMQP addresses, for example, <code>collectd/telemetry</code>. STF Smart Gateways listen on those AMQP addresses for data. To support multiple clouds and to identify which cloud generated the monitoring data, configure each cloud to send data to a unique address. Add a cloud identifier prefix to the second part of the address. The following list shows some example addresses and identifiers:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>collectd/cloud1-telemetry</code></p>
</li>
<li>
<p><code>collectd/cloud1-notify</code></p>
</li>
<li>
<p><code>sensubility/cloud1-telemetry</code></p>
</li>
<li>
<p><code>anycast/ceilometer/cloud1-metering.sample</code></p>
</li>
<li>
<p><code>anycast/ceilometer/cloud1-event.sample</code></p>
</li>
<li>
<p><code>collectd/cloud2-telemetry</code></p>
</li>
<li>
<p><code>collectd/cloud2-notify</code></p>
</li>
<li>
<p><code>sensubility/cloud2-telemetry</code></p>
</li>
<li>
<p><code>anycast/ceilometer/cloud2-metering.sample</code></p>
</li>
<li>
<p><code>anycast/ceilometer/cloud2-event.sample</code></p>
</li>
<li>
<p><code>collectd/us-east-1-telemetry</code></p>
</li>
<li>
<p><code>collectd/us-west-3-telemetry</code></p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="deploying-smart-gateways_assembly-completing-the-stf-configuration">Deploying Smart Gateways</h4>
<div class="paragraph _abstract">
<p>You must deploy a Smart Gateway for each of the data collection types for each cloud; one for collectd metrics, one for collectd events, one for Ceilometer metrics, one for Ceilometer events, and one for collectd-sensubility metrics. Configure each of the Smart Gateways to listen on the AMQP address that you define for the corresponding cloud. To define Smart Gateways, configure the <code>clouds</code> parameter in the <code>ServiceTelemetry</code> manifest.</p>
</div>
<div class="paragraph">
<p>When you deploy STF for the first time, Smart Gateway manifests are created that define the initial Smart Gateways for a single cloud. When you deploy Smart Gateways for multiple cloud support, you deploy multiple Smart Gateways for each of the data collection types that handle the metrics and the events data for each cloud. The initial Smart Gateways are defined in <code>cloud1</code> with the following subscription addresses:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 33.3333%;"/>
<col style="width: 33.3333%;"/>
<col style="width: 33.3334%;"/>
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>collector</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>type</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>default subscription address</strong></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">collectd</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">metrics</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">collectd/telemetry</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">collectd</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">events</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">collectd/notify</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">collectd-sensubility</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">metrics</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">sensubility/telemetry</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Ceilometer</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">metrics</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">anycast/ceilometer/metering.sample</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Ceilometer</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">events</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">anycast/ceilometer/event.sample</p></td>
</tr>
</tbody>
</table>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>You have determined your cloud naming scheme. For more information about determining your naming scheme, see <a href="#planning-amqp-address-prefixes_assembly-completing-the-stf-configuration">Planning AMQP address prefixes</a>.</p>
</li>
<li>
<p>You have created your list of clouds objects. For more information about creating the content for the <code>clouds</code> parameter, see <a href="#clouds_assembly-installing-the-core-components-of-stf">The clouds parameter</a>.</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Log in to OpenShift.</p>
</li>
<li>
<p>Change to the <code>service-telemetry</code> namespace:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">$ oc project service-telemetry</code></pre>
</div>
</div>
</li>
<li>
<p>Edit the <code>default</code> ServiceTelemetry object and add a <code>clouds</code> parameter with your configuration:</p>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Long cloud names might exceed the maximum pod name of 63 characters. Ensure that the combination of the <code>ServiceTelemetry</code> name <code>default</code> and the <code>clouds.name</code> does not exceed 19 characters. Cloud names cannot contain any special characters, such as <code>-</code>. Limit cloud names to alphanumeric (a-z, 0-9).</p>
</div>
<div class="paragraph">
<p>Topic addresses have no character limitation and can be different from the <code>clouds.name</code> value.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">$ oc edit stf default</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-yaml hljs" data-lang="yaml">apiVersion: infra.watch/v1beta1
kind: ServiceTelemetry
metadata:
  ...
spec:
  ...
  clouds:
  - name: cloud1
    events:
      collectors:
      - collectorType: collectd
        subscriptionAddress: collectd/cloud1-notify
      - collectorType: ceilometer
        subscriptionAddress: anycast/ceilometer/cloud1-event.sample
    metrics:
      collectors:
      - collectorType: collectd
        subscriptionAddress: collectd/cloud1-telemetry
      - collectorType: sensubility
        subscriptionAddress: sensubility/cloud1-telemetry
      - collectorType: ceilometer
        subscriptionAddress: anycast/ceilometer/cloud1-metering.sample
  - name: cloud2
    events:
      ...</code></pre>
</div>
</div>
</li>
<li>
<p>Save the ServiceTelemetry object.</p>
</li>
<li>
<p>Verify that each Smart Gateway is running. This can take several minutes depending on the number of Smart Gateways:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-bash hljs" data-lang="bash">$ oc get po -l app=smart-gateway
NAME                                                      READY   STATUS    RESTARTS   AGE
default-cloud1-ceil-event-smartgateway-6cfb65478c-g5q82   2/2     Running   0          13h
default-cloud1-ceil-meter-smartgateway-58f885c76d-xmxwn   2/2     Running   0          13h
default-cloud1-coll-event-smartgateway-58fbbd4485-rl9bd   2/2     Running   0          13h
default-cloud1-coll-meter-smartgateway-7c6fc495c4-jn728   2/2     Running   0          13h
default-cloud1-sens-meter-smartgateway-8h4tc445a2-mm683   2/2     Running   0          13h</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="deleting-the-default-smart-gateways_assembly-completing-the-stf-configuration">Deleting the default Smart Gateways</h4>
<div class="paragraph _abstract">
<p>After you configure Service&#160;Telemetry&#160;Framework (STF) for multiple clouds, you can delete the default Smart Gateways if they are no longer in use. The Service Telemetry Operator can remove <code>SmartGateway</code> objects that were created but are no longer listed in the ServiceTelemetry <code>clouds</code> list of objects. To enable the removal of SmartGateway objects that are not defined by the <code>clouds</code> parameter, you must set the <code>cloudsRemoveOnMissing</code> parameter to <code>true</code> in the <code>ServiceTelemetry</code> manifest.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
If you do not want to deploy any Smart Gateways, define an empty clouds list by using the <code>clouds: []</code> parameter.
</td>
</tr>
</table>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
The <code>cloudsRemoveOnMissing</code> parameter is disabled by default. If you enable the <code>cloudsRemoveOnMissing</code> parameter, you remove any manually created <code>SmartGateway</code> objects in the current namespace without any possibility to restore.
</td>
</tr>
</table>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Define your <code>clouds</code> parameter with the list of cloud objects that you want the Service Telemetry Operator to manage. For more information, see <a href="#clouds_assembly-installing-the-core-components-of-stf">The clouds parameter</a>.</p>
</li>
<li>
<p>Edit the ServiceTelemetry object and add the <code>cloudsRemoveOnMissing</code> parameter:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: infra.watch/v1beta1
kind: ServiceTelemetry
metadata:
  ...
spec:
  ...
  cloudsRemoveOnMissing: true
  clouds:
    ...</code></pre>
</div>
</div>
</li>
<li>
<p>Save the modifications.</p>
</li>
<li>
<p>Verify that the Operator deleted the Smart Gateways. This can take several minutes while the Operators reconcile the changes:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">$ oc get smartgateways</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="setting-a-unique-cloud-domain_assembly-completing-the-stf-configuration">Setting a unique cloud domain</h4>
<div class="paragraph _abstract">
<p>To ensure that Apache&#160;Qpid&#160;Dispatch&#160;Router router connections from OpenStack (OSP) to Service&#160;Telemetry&#160;Framework (STF) are unique and do not conflict, configure the <code>CloudDomain</code> parameter.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Create a new environment file, for example, <code>hostnames.yaml</code>.</p>
</li>
<li>
<p>Set the <code>CloudDomain</code> parameter in the environment file, as shown in the following example:</p>
<div class="listingblock">
<div class="title">hostnames.yaml</div>
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-yaml hljs" data-lang="yaml">parameter_defaults:
    CloudDomain: newyork-west-04
    CephStorageHostnameFormat: 'ceph-%index%'
    ObjectStorageHostnameFormat: 'swift-%index%'
    ComputeHostnameFormat: 'compute-%index%'</code></pre>
</div>
</div>
</li>
<li>
<p>Add the new environment file to your deployment.</p>
</li>
</ol>
</div>
<div class="ulist">
<div class="title">Additional resources</div>
<ul>
<li>
<p><a href="#creating-openstack-environment-file-for-multiple-clouds_assembly-completing-the-stf-configuration">Creating the OpenStack environment file for multiple clouds</a></p>
</li>
<li>
<p><a href="https://access.redhat.com/documentation/en-us/red_hat_openstack_platform/16.2/html-single/overcloud_parameters/index#ref_core-overcloud-parameters_overcloud_parameters">Core Overcloud Parameters</a> in the <em>Overcloud Parameters</em> guide</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="creating-openstack-environment-file-for-multiple-clouds_assembly-completing-the-stf-configuration">Creating the OpenStack environment file for multiple clouds</h4>
<div class="paragraph _abstract">
<p>To label traffic according to the cloud of origin, you must create a configuration with cloud-specific instance names. Create an <code>stf-connectors.yaml</code> file and adjust the values of <code>CeilometerQdrEventsConfig</code>, <code>CeilometerQdrMetricsConfig</code> and <code>CollectdAmqpInstances</code> to match the AMQP address prefix scheme.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If you enabled container health and API status monitoring, you must also modify the <code>CollectdSensubilityResultsChannel</code> parameter. For more information, see <a href="#container-health-and-api-status_assembly-advanced-features">OpenStack API status and containerized services health</a>.
</td>
</tr>
</table>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>You have created your list of clouds objects. For more information about creating the content for the clouds parameter, see the <a href="#clouds_assembly-installing-the-core-components-of-stf">clouds configuration parameter</a>.</p>
</li>
<li>
<p>You have retrieved the Apache&#160;Qpid&#160;Dispatch&#160;Router route address. For more information, see <a href="#retrieving-the-qdr-route-address_assembly-completing-the-stf-configuration">Retrieving the Apache&#160;Qpid&#160;Dispatch&#160;Router route address</a>.</p>
</li>
<li>
<p>You have created the base configuration for STF. For more information, see <a href="#creating-the-base-configuration-for-stf_assembly-completing-the-stf-configuration">Creating the base configuration for STF</a>.</p>
</li>
<li>
<p>You have created a unique domain name environment file. For more information, see <a href="#setting-a-unique-cloud-domain_assembly-completing-the-stf-configuration">Setting a unique cloud domain</a>.</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Log in to the OpenStack undercloud as the <code>stack</code> user.</p>
</li>
<li>
<p>Create a configuration file called <code>stf-connectors.yaml</code> in the <code>/home/stack</code> directory.</p>
</li>
<li>
<p>In the <code>stf-connectors.yaml</code> file, configure the <code>MetricsQdrConnectors</code> address to connect to the Apache&#160;Qpid&#160;Dispatch&#160;Router on the overcloud deployment. Configure the <code>CeilometerQdrEventsConfig</code>, <code>CeilometerQdrMetricsConfig</code>, <code>CollectdAmqpInstances</code>, and <code>CollectdSensubilityResultsChannel</code> topic values to match the AMQP address that you want for this cloud deployment.</p>
<div class="ulist">
<ul>
<li>
<p>The <code>resource_registry</code> configuration directly loads the collectd service because you do not include the <code>collectd-write-qdr.yaml</code> environment file for multiple cloud deployments.</p>
</li>
<li>
<p>Set the <code>CeilometerQdrEventsConfig.topic</code> to define the topic for Ceilometer events. This value is the address format of <code>anycast/ceilometer/cloud1-event.sample</code>.</p>
</li>
<li>
<p>Set the <code>CeilometerQdrMetricsConfig.topic</code> to define the topic for Ceilometer metrics. This value is the address format of <code>anycast/ceilometer/cloud1-metering.sample</code>.</p>
</li>
<li>
<p>Set the <code>CollectdAmqpInstances</code> to define the topic for collectd events. This value is the format of <code>collectd/cloud1-notify</code>.</p>
</li>
<li>
<p>Set the <code>CollectdAmqpInstances</code> to define the topic for collectd metrics. This value is the format of <code>collectd/cloud1-telemetry</code>.</p>
</li>
<li>
<p>Set the <code>CollectdSensubilityResultsChannel</code> to define the topic for collectd-sensubility events. This value is the format of <code>sensubility/cloud1-telemetry</code></p>
<div class="listingblock">
<div class="title">stf-connectors.yaml</div>
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-yaml hljs" data-lang="yaml">resource_registry:
  OS::TripleO::Services::Collectd: /usr/share/openstack-tripleo-heat-templates/deployment/metrics/collectd-container-puppet.yaml

parameter_defaults:
    MetricsQdrConnectors:
        - host: stf-default-interconnect-5671-service-telemetry.apps.infra.watch
          port: 443
          role: edge
          verifyHostname: false
          sslProfile: sslProfile

    MetricsQdrSSLProfiles:
        - name: sslProfile

    CeilometerQdrEventsConfig:
        driver: amqp
        topic: cloud1-event

    CeilometerQdrMetricsConfig:
        driver: amqp
        topic: cloud1-metering

    CollectdAmqpInstances:
        cloud1-notify:
            notify: true
            format: JSON
            presettle: false
        cloud1-telemetry:
            format: JSON
            presettle: false

    CollectdSensubilityResultsChannel: sensubility/cloud1-telemetry</code></pre>
</div>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>Ensure that the naming convention in the <code>stf-connectors.yaml</code> file aligns with the <code>spec.bridge.amqpUrl</code> field in the Smart Gateway configuration. For example, configure the <code>CeilometerQdrEventsConfig.topic</code> field to a value of <code>cloud1-event</code>.</p>
</li>
<li>
<p>Source the authentication file:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">[stack@undercloud-0 ~]$ source stackrc

(undercloud) [stack@undercloud-0 ~]$</code></pre>
</div>
</div>
</li>
<li>
<p>Include the <code>stf-connectors.yaml</code> file and unique domain name environment file <code>hostnames.yaml</code> in the <code>openstack overcloud deployment</code> command, with any other environment files relevant to your environment:</p>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
If you use the <code>collectd-write-qdr.yaml</code> file with a custom <code>CollectdAmqpInstances</code> parameter, data publishes to the custom and default topics. In a multiple cloud environment, the configuration of the <code>resource_registry</code> parameter in the <code>stf-connectors.yaml</code> file loads the collectd service.
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-bash hljs" data-lang="bash">(undercloud) [stack@undercloud-0 ~]$ openstack overcloud deploy <em>&lt;other_arguments&gt;</em>
--templates /usr/share/openstack-tripleo-heat-templates \
  --environment-file <em>&lt;...other_environment_files...&gt;</em> \
  --environment-file /usr/share/openstack-tripleo-heat-templates/environments/metrics/ceilometer-write-qdr.yaml \
  --environment-file /usr/share/openstack-tripleo-heat-templates/environments/metrics/qdr-edge-only.yaml \
  --environment-file /home/stack/hostnames.yaml \
  --environment-file /home/stack/enable-stf.yaml \
  --environment-file /home/stack/stf-connectors.yaml</code></pre>
</div>
</div>
</li>
<li>
<p>Deploy the OpenStack overcloud.</p>
</li>
</ol>
</div>
<div class="ulist">
<div class="title">Additional resources</div>
<ul>
<li>
<p>For information about how to validate the deployment, see <a href="#validating-clientside-installation_assembly-completing-the-stf-configuration">Validating client-side installation</a>.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="querying-metrics-data-from-multiple-clouds_assembly-completing-the-stf-configuration">Querying metrics data from multiple clouds</h4>
<div class="paragraph _abstract">
<p>Data stored in Prometheus has a <code>service</code> label according to the Smart Gateway it was scraped from. You can use this label to query data from a specific cloud.</p>
</div>
<div class="paragraph">
<p>To query data from a specific cloud, use a Prometheus <em>promql</em> query that matches the associated <code>service</code> label; for example: <code>collectd_uptime{service="default-cloud1-coll-meter"}</code>.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="assembly-advanced-features_assembly">Using operational features of Service&#160;Telemetry&#160;Framework</h2>
<div class="sectionbody">
<div class="paragraph _abstract">
<p>You can use the following operational features to provide additional functionality to the Service&#160;Telemetry&#160;Framework (STF):</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#dashboards_assembly-advanced-features">Configuring dashboards</a></p>
</li>
<li>
<p><a href="#metrics-retention-time-period_assembly-advanced-features">Configuring the metrics retention time period</a></p>
</li>
<li>
<p><a href="#alerts_assembly-advanced-features">Configuring alerts</a></p>
</li>
<li>
<p><a href="#configuring-snmp-traps_assembly-advanced-features">Configuring SNMP traps</a></p>
</li>
<li>
<p><a href="#high-availability_assembly-advanced-features">Configuring high availability</a></p>
</li>
<li>
<p><a href="#ephemeral-storage_assembly-advanced-features">Configuring ephemeral storage</a></p>
</li>
<li>
<p><a href="#observability-strategy-in-service-telemetry-framework_assembly-advanced-features">Configuring an alternate observability strategy</a></p>
</li>
<li>
<p><a href="#resource-usage-of-openstack-services_assembly-advanced-features">Monitoring the resource use of OpenStack services</a></p>
</li>
<li>
<p><a href="#container-health-and-api-status_assembly-advanced-features">Monitoring container health and API status</a></p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="dashboards_assembly-advanced-features">Dashboards in Service&#160;Telemetry&#160;Framework</h3>
<div class="paragraph _abstract">
<p>Use the third-party application, Grafana, to visualize system-level metrics that collectd and Ceilometer gathers for each individual host node.</p>
</div>
<div class="paragraph">
<p>For more information about configuring collectd, see <a href="#configuring-red-hat-openstack-platform-overcloud-for-stf_assembly-completing-the-stf-configuration">Deploying OpenStack overcloud for Service&#160;Telemetry&#160;Framework</a>.</p>
</div>
<div class="paragraph">
<p>You can use two dashboards to monitor a cloud:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Infrastructure dashboard</dt>
<dd>
<p>Use the infrastructure dashboard to view metrics for a single node at a time. Select a node from the upper left corner of the dashboard.</p>
</dd>
<dt class="hdlist1">Cloud view dashboard</dt>
<dd>
<p>Use the cloud view dashboard to view panels to monitor service resource usage, API stats, and cloud events. You must enable API health monitoring and service monitoring to provide the data for this dashboard. API health monitoring is enabled by default in the STF base configuration. For more information, see <a href="#creating-the-base-configuration-for-stf_assembly-completing-the-stf-configuration">Creating the base configuration for STF</a>.</p>
<div class="ulist">
<ul>
<li>
<p>For more information about API health monitoring, see <a href="#container-health-and-api-status_assembly-advanced-features">OpenStack API status and containerized services health</a>.</p>
</li>
<li>
<p>For more information about OSP service monitoring, see <a href="#resource-usage-of-openstack-services_assembly-advanced-features">Resource usage of OpenStack services</a>.</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
<div class="sect3">
<h4 id="setting-up-grafana-to-host-the-dashboard_assembly-advanced-features">Configuring Grafana to host the dashboard</h4>
<div class="paragraph _abstract">
<p>Grafana is not included in the default Service&#160;Telemetry&#160;Framework (STF) deployment so you must deploy the Grafana Operator from OperatorHub.io. When you use the Service Telemetry Operator to deploy Grafana, it results in a Grafana instance and the configuration of the default data sources for the local STF deployment.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Log in to OpenShift.</p>
</li>
<li>
<p>Change to the <code>service-telemetry</code> namespace:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">$ oc project service-telemetry</code></pre>
</div>
</div>
</li>
<li>
<p>Deploy the Grafana operator:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">$ oc apply -f - &lt;&lt;EOF
apiVersion: operators.coreos.com/v1alpha1
kind: Subscription
metadata:
  name: grafana-operator
  namespace: service-telemetry
spec:
  channel: v4
  installPlanApproval: Automatic
  name: grafana-operator
  source: operatorhubio-operators
  sourceNamespace: openshift-marketplace
EOF</code></pre>
</div>
</div>
</li>
<li>
<p>Verify that the Operator launched successfully. In the command output, if the value of the <code>PHASE</code> column is <code>Succeeded</code>, the Operator launched successfully:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-bash hljs" data-lang="bash">$ oc get csv --selector operators.coreos.com/grafana-operator.service-telemetry

NAME                       DISPLAY            VERSION   REPLACES                   PHASE
grafana-operator.v4.6.0   Grafana Operator   4.6.0     grafana-operator.v4.5.1   Succeeded</code></pre>
</div>
</div>
</li>
<li>
<p>To launch a Grafana instance, create or modify the <code>ServiceTelemetry</code> object. Set <code>graphing.enabled</code> and <code>graphing.grafana.ingressEnabled</code> to <code>true</code>:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">$ oc edit stf default

apiVersion: infra.watch/v1beta1
kind: ServiceTelemetry
...
spec:
  ...
  graphing:
    enabled: true
    grafana:
      ingressEnabled: true</code></pre>
</div>
</div>
</li>
<li>
<p>Verify that the Grafana instance deployed:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">$ oc get pod -l app=grafana

NAME                                  READY   STATUS    RESTARTS   AGE
grafana-deployment-7fc7848b56-sbkhv   1/1     Running   0          1m</code></pre>
</div>
</div>
</li>
<li>
<p>Verify that the Grafana data sources installed correctly:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">$ oc get grafanadatasources

NAME                    AGE
default-datasources     20h</code></pre>
</div>
</div>
</li>
<li>
<p>Verify that the Grafana route exists:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-bash hljs" data-lang="bash">$ oc get route grafana-route

NAME            HOST/PORT                                          PATH   SERVICES          PORT   TERMINATION   WILDCARD
grafana-route   grafana-route-service-telemetry.apps.infra.watch          grafana-service   3000   edge          None</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="overriding-the-default-grafana-container-image_assembly-advanced-features">Overriding the default Grafana container image</h4>
<div class="paragraph">
<p>The dashboards in Service&#160;Telemetry&#160;Framework (STF) require features that are available only in Grafana version 8.1.0 and later. By default, the Service Telemetry Operator installs a compatible version. You can override the base Grafana image by specifying the image path to an image registry with <code>graphing.grafana.baseImage</code>.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Ensure that you have the correct version of Grafana:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-bash hljs" data-lang="bash">$ oc get pod -l "app=grafana" -ojsonpath='{.items[0].spec.containers[0].image}'
docker.io/grafana/grafana:7.3.10</code></pre>
</div>
</div>
</li>
<li>
<p>If the running image is older than 8.1.0, patch the ServiceTelemetry object to update the image. Service Telemetry Operator updates the Grafana manifest, which restarts the Grafana deployment:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-bash hljs" data-lang="bash">$ oc patch stf/default --type merge -p '{"spec":{"graphing":{"grafana":{"baseImage":"docker.io/grafana/grafana:8.1.5"}}}}'</code></pre>
</div>
</div>
</li>
<li>
<p>Verify that a new Grafana pod exists and has a <code>STATUS</code> value of <code>Running</code>:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-bash hljs" data-lang="bash">$ oc get pod -l "app=grafana"
NAME                                 READY     STATUS    RESTARTS   AGE
grafana-deployment-fb9799b58-j2hj2   1/1       Running   0          10s</code></pre>
</div>
</div>
</li>
<li>
<p>Verify that the new instance is running the updated image:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-bash hljs" data-lang="bash">$ oc get pod -l "app=grafana" -ojsonpath='{.items[0].spec.containers[0].image}'
docker.io/grafana/grafana:8.1.0</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="importing-dashboards_assembly-advanced-features">Importing dashboards</h4>
<div class="paragraph _abstract">
<p>The Grafana Operator can import and manage dashboards by creating <code>GrafanaDashboard</code> objects. You can view example dashboards at <a href="https://github.com/infrawatch/dashboards" class="bare">https://github.com/infrawatch/dashboards</a>.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Import the infrastructure dashboard:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-bash hljs" data-lang="bash">$ oc apply -f https://raw.githubusercontent.com/infrawatch/dashboards/master/deploy/stf-1.3/rhos-dashboard.yaml

grafanadashboard.integreatly.org/rhos-dashboard-1.3 created</code></pre>
</div>
</div>
</li>
<li>
<p>Import the cloud dashboard:</p>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
For some panels in the cloud dashboard, you must set the value of the collectd <code>virt</code> plugin parameter <code>hostname_format</code> to <code>name uuid hostname</code> in the <code>stf-connectors.yaml</code> file. If you do not configure this parameter, affected dashboards remain empty. For more information about the <code>virt</code> plugin, see <a href="https://access.redhat.com/documentation/en-us/red_hat_openstack_platform/16.2/html-single/service_telemetry_framework_1.5/index#collectd-plugins_assembly">collectd plugins</a>.
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-bash hljs" data-lang="bash">$ oc apply -f https://raw.githubusercontent.com/infrawatch/dashboards/master/deploy/stf-1.3/rhos-cloud-dashboard.yaml

grafanadashboard.integreatly.org/rhos-cloud-dashboard-1.3 created</code></pre>
</div>
</div>
</li>
<li>
<p>Import the cloud events dashboard:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-bash hljs" data-lang="bash">$ oc apply -f https://raw.githubusercontent.com/infrawatch/dashboards/master/deploy/stf-1.3/rhos-cloudevents-dashboard.yaml

grafanadashboard.integreatly.org/rhos-cloudevents-dashboard created</code></pre>
</div>
</div>
</li>
<li>
<p>Import the virtual machine dashboard:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-bash hljs" data-lang="bash">$ oc apply -f https://raw.githubusercontent.com/infrawatch/dashboards/master/deploy/stf-1.3/virtual-machine-view.yaml

grafanadashboard.integreatly.org/virtual-machine-view-1.3 configured</code></pre>
</div>
</div>
</li>
<li>
<p>Import the memcached dashboard:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-bash hljs" data-lang="bash">$ oc apply -f https://raw.githubusercontent.com/infrawatch/dashboards/master/deploy/stf-1.3/memcached-dashboard.yaml

grafanadashboard.integreatly.org/memcached-dashboard-1.3 created</code></pre>
</div>
</div>
</li>
<li>
<p>Verify that the dashboards are available:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">$ oc get grafanadashboards

NAME                   AGE
memcached-dashboard-1.3      115s
rhos-cloud-dashboard-1.3     2m12s
rhos-cloudevents-dashboard   2m6s
rhos-dashboard-1.3           2m17s
virtual-machine-view-1.3     2m</code></pre>
</div>
</div>
</li>
<li>
<p>Retrieve the Grafana route address:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-bash hljs" data-lang="bash">$ oc get route grafana-route -ojsonpath='{.spec.host}'

grafana-route-service-telemetry.apps.infra.watch</code></pre>
</div>
</div>
</li>
<li>
<p>In a web browser, navigate to https://<em>&lt;grafana_route_address&gt;</em>. Replace <em>&lt;grafana_route_address&gt;</em> with the value that you retrieved in the previous step.</p>
</li>
<li>
<p>To view the dashboard, click <strong>Dashboards</strong> and <strong>Manage</strong>.</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="proc-retrieving-and-setting-grafana-credentials_assembly-advanced-features">Retrieving and setting Grafana login credentials</h4>
<div class="paragraph _abstract">
<p>Service&#160;Telemetry&#160;Framework (STF) sets default login credentials when Grafana is enabled. You can override the credentials in the <code>ServiceTelemetry</code> object.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Log in to OpenShift.</p>
</li>
<li>
<p>Change to the <code>service-telemetry</code> namespace:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">$ oc project service-telemetry</code></pre>
</div>
</div>
</li>
<li>
<p>Retrieve the default username and password from the STF object:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">$ oc get stf default -o jsonpath="{.spec.graphing.grafana['adminUser','adminPassword']}"</code></pre>
</div>
</div>
</li>
<li>
<p>To modify the default values of the Grafana administrator username and password through the ServiceTelemetry object, use the <code>graphing.grafana.adminUser</code> and <code>graphing.grafana.adminPassword</code> parameters.</p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect2">
<h3 id="metrics-retention-time-period_assembly-advanced-features">Metrics retention time period in Service&#160;Telemetry&#160;Framework</h3>
<div class="paragraph _abstract">
<p>The default retention time for metrics stored in Service&#160;Telemetry&#160;Framework (STF) is 24 hours, which provides enough data for trends to develop for the purposes of alerting.</p>
</div>
<div class="paragraph">
<p>For long-term storage, use systems designed for long-term data retention, for example, Thanos.</p>
</div>
<div class="ulist">
<div class="title">Additional resources</div>
<ul>
<li>
<p>To adjust STF for additional metrics retention time, see <a href="#editing-the-metrics-retention-time-period-in-service-telemetry-framework_assembly-advanced-features">Editing the metrics retention time period in Service Telemetry Framework</a>.</p>
</li>
<li>
<p>For recommendations about Prometheus data storage and estimating storage space, see <a href="https://prometheus.io/docs/prometheus/latest/storage/#operational-aspects" class="bare">https://prometheus.io/docs/prometheus/latest/storage/#operational-aspects</a></p>
</li>
<li>
<p>For more information about Thanos, see <a href="https://thanos.io/" class="bare">https://thanos.io/</a></p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="editing-the-metrics-retention-time-period-in-service-telemetry-framework_assembly-advanced-features">Editing the metrics retention time period in Service Telemetry Framework</h4>
<div class="paragraph _abstract">
<p>You can adjust Service&#160;Telemetry&#160;Framework (STF) for additional metrics retention time.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Log in to OpenShift.</p>
</li>
<li>
<p>Change to the service-telemetry namespace:</p>
<div class="listingblock white-space-pre">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-bash hljs" data-lang="bash">$ oc project service-telemetry</code></pre>
</div>
</div>
</li>
<li>
<p>Edit the ServiceTelemetry object:</p>
<div class="listingblock white-space-pre">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-bash hljs" data-lang="bash">$ oc edit stf default</code></pre>
</div>
</div>
</li>
<li>
<p>Add <code>retention: 7d</code>  to the storage section of backends.metrics.prometheus.storage to increase the retention period to seven days:</p>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If you set a long retention period, retrieving data from heavily populated Prometheus systems can result in queries returning results slowly.
</td>
</tr>
</table>
</div>
<div class="listingblock white-space-pre">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-yaml hljs" data-lang="yaml">apiVersion: infra.watch/v1beta1
kind: ServiceTelemetry
metadata:
  name: stf-default
  namespace: service-telemetry
spec:
  ...
  backends:
    metrics:
      prometheus:
        enabled: true
        storage:
          strategy: persistent
          retention: 7d
    ...</code></pre>
</div>
</div>
</li>
<li>
<p>Save your changes and close the object.</p>
</li>
</ol>
</div>
<div class="ulist">
<div class="title">Additional resources</div>
<ul>
<li>
<p>For more information about the metrics retention time, see <a href="#metrics-retention-time-period_assembly-advanced-features">Metrics retention time period in Service&#160;Telemetry&#160;Framework</a>.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="alerts_assembly-advanced-features">Alerts in Service&#160;Telemetry&#160;Framework</h3>
<div class="paragraph _abstract">
<p>You create alert rules in Prometheus and alert routes in Alertmanager. Alert rules in Prometheus servers send alerts to an Alertmanager, which manages the alerts. Alertmanager can silence, inhibit, or aggregate alerts, and send notifications by using email, on-call notification systems, or chat platforms.</p>
</div>
<div class="paragraph">
<p>To create an alert, complete the following tasks:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Create an alert rule in Prometheus. For more information, see <a href="#creating-an-alert-rule-in-prometheus_assembly-advanced-features">Creating an alert rule in Prometheus</a>.</p>
</li>
<li>
<p>Create an alert route in Alertmanager. There are two ways in which you can create an alert route:</p>
<div class="ulist">
<ul>
<li>
<p><a href="#creating-an-alert-route-in-alertmanager_assembly-advanced-features">Creating a standard alert route in Alertmanager</a>.</p>
</li>
<li>
<p><a href="#creating-an-alert-route-with-templating-in-alertmanager_assembly-advanced-features">Creating an alert route with templating in Alertmanager</a>.</p>
</li>
</ul>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<div class="title">Additional resources</div>
<p>For more information about alerts or notifications with Prometheus and Alertmanager, see <a href="https://prometheus.io/docs/alerting/overview/" class="bare">https://prometheus.io/docs/alerting/overview/</a></p>
</div>
<div class="paragraph">
<p>To view an example set of alerts that you can use with Service&#160;Telemetry&#160;Framework (STF), see <a href="https://github.com/infrawatch/service-telemetry-operator/tree/master/deploy/alerts" class="bare">https://github.com/infrawatch/service-telemetry-operator/tree/master/deploy/alerts</a></p>
</div>
<div class="sect3">
<h4 id="creating-an-alert-rule-in-prometheus_assembly-advanced-features">Creating an alert rule in Prometheus</h4>
<div class="paragraph _abstract">
<p>Prometheus evaluates alert rules to trigger notifications. If the rule condition returns an empty result set, the condition is false. Otherwise, the rule is true and it triggers an alert.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Log in to OpenShift.</p>
</li>
<li>
<p>Change to the <code>service-telemetry</code> namespace:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">$ oc project service-telemetry</code></pre>
</div>
</div>
</li>
<li>
<p>Create a <code>PrometheusRule</code> object that contains the alert rule. The Prometheus Operator loads the rule into Prometheus:</p>
<div class="listingblock white-space-pre">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-yaml hljs" data-lang="yaml">$ oc apply -f - &lt;&lt;EOF
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  creationTimestamp: null
  labels:
    prometheus: default
    role: alert-rules
  name: prometheus-alarm-rules
  namespace: service-telemetry
spec:
  groups:
    - name: ./openstack.rules
      rules:
        - alert: Collectd metrics receive rate is zero
          expr: rate(sg_total_collectd_msg_received_count[1m]) == 0
EOF</code></pre>
</div>
</div>
<div class="paragraph">
<p>To change the rule, edit the value of the <code>expr</code> parameter.</p>
</div>
</li>
<li>
<p>To verify that the Operator loaded the rules into Prometheus, run the <code>curl</code> command against the default-prometheus-proxy route with basic authentication:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-bash hljs" data-lang="bash">$ curl -k --user "internal:$(oc get secret default-prometheus-htpasswd -ogo-template='{{ .data.password | base64decode }}')" https://$(oc get route default-prometheus-proxy -ogo-template='{{ .spec.host }}')/api/v1/rules

{"status":"success","data":{"groups":[{"name":"./openstack.rules","file":"/etc/prometheus/rules/prometheus-default-rulefiles-0/service-telemetry-prometheus-alarm-rules.yaml","rules":[{"state":"inactive","name":"Collectd metrics receive count is zero","query":"rate(sg_total_collectd_msg_received_count[1m]) == 0","duration":0,"labels":{},"annotations":{},"alerts":[],"health":"ok","evaluationTime":0.00034627,"lastEvaluation":"2021-12-07T17:23:22.160448028Z","type":"alerting"}],"interval":30,"evaluationTime":0.000353787,"lastEvaluation":"2021-12-07T17:23:22.160444017Z"}]}}</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="ulist">
<div class="title">Additional resources</div>
<ul>
<li>
<p>For more information on alerting, see <a href="https://github.com/coreos/prometheus-operator/blob/master/Documentation/user-guides/alerting.md" class="bare">https://github.com/coreos/prometheus-operator/blob/master/Documentation/user-guides/alerting.md</a></p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="configuring-custom-alerts_assembly-advanced-features">Configuring custom alerts</h4>
<div class="paragraph _abstract">
<p>You can add custom alerts to the <code>PrometheusRule</code> object that you created in <a href="#creating-an-alert-rule-in-prometheus_assembly-advanced-features">Creating an alert rule in Prometheus</a>.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Use the <code>oc edit</code> command:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">$ oc edit prometheusrules prometheus-alarm-rules</code></pre>
</div>
</div>
</li>
<li>
<p>Edit the <code>PrometheusRules</code> manifest.</p>
</li>
<li>
<p>Save and close the manifest.</p>
</li>
</ol>
</div>
<div class="ulist">
<div class="title">Additional resources</div>
<ul>
<li>
<p>For more information about how to configure alerting rules, see <a href="https://prometheus.io/docs/prometheus/latest/configuration/alerting_rules/" class="bare">https://prometheus.io/docs/prometheus/latest/configuration/alerting_rules/</a>.</p>
</li>
<li>
<p>For more information about PrometheusRules objects, see <a href="https://github.com/coreos/prometheus-operator/blob/master/Documentation/user-guides/alerting.md" class="bare">https://github.com/coreos/prometheus-operator/blob/master/Documentation/user-guides/alerting.md</a></p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="creating-an-alert-route-in-alertmanager_assembly-advanced-features">Creating a standard alert route in Alertmanager</h4>
<div class="paragraph _abstract">
<p>Use Alertmanager to deliver alerts to an external system, such as email, IRC, or other notification channel. The Prometheus Operator manages the Alertmanager configuration as a OpenShift secret. By default, Service&#160;Telemetry&#160;Framework (STF) deploys a basic configuration that results in no receivers:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">alertmanager.yaml: |-
  global:
    resolve_timeout: 5m
  route:
    group_by: ['job']
    group_wait: 30s
    group_interval: 5m
    repeat_interval: 12h
    receiver: 'null'
  receivers:
  - name: 'null'</code></pre>
</div>
</div>
<div class="paragraph">
<p>To deploy a custom Alertmanager route with STF, you must pass an <code>alertmanagerConfigManifest</code> parameter to the Service Telemetry Operator that results in an updated secret, managed by the Prometheus Operator.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If your <code>alertmanagerConfigManifest</code> contains a custom template to construct the title and text of the sent alert, deploy the contents of the <code>alertmanagerConfigManifest</code> using a base64-encoded configuration. For more information, see <a href="#creating-an-alert-route-with-templating-in-alertmanager_assembly-advanced-features">Creating an alert route with templating in Alertmanager</a>.
</td>
</tr>
</table>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Log in to OpenShift.</p>
</li>
<li>
<p>Change to the <code>service-telemetry</code> namespace:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">$ oc project service-telemetry</code></pre>
</div>
</div>
</li>
<li>
<p>Edit the <code>ServiceTelemetry</code> object for your STF deployment:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">$ oc edit stf default</code></pre>
</div>
</div>
</li>
<li>
<p>Add the new parameter <code>alertmanagerConfigManifest</code> and the <code>Secret</code> object contents to define the <code>alertmanager.yaml</code> configuration for Alertmanager:</p>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
This step loads the default template that the Service Telemetry Operator manages. To verify that the changes are populating correctly, change a value, return the <code>alertmanager-default</code> secret, and verify that the new value is loaded into memory. For example, change the value of the parameter <code>global.resolve_timeout</code> from <code>5m</code> to <code>10m</code>.
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-yaml hljs" data-lang="yaml">apiVersion: infra.watch/v1beta1
kind: ServiceTelemetry
metadata:
  name: default
  namespace: service-telemetry
spec:
  backends:
    metrics:
      prometheus:
        enabled: true
  alertmanagerConfigManifest: |
    apiVersion: v1
    kind: Secret
    metadata:
      name: 'alertmanager-default'
      namespace: 'service-telemetry'
    type: Opaque
    stringData:
      alertmanager.yaml: |-
        global:
          resolve_timeout: 10m
        route:
          group_by: ['job']
          group_wait: 30s
          group_interval: 5m
          repeat_interval: 12h
          receiver: 'null'
        receivers:
        - name: 'null'</code></pre>
</div>
</div>
</li>
<li>
<p>Verify that the configuration has been applied to the secret:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-bash hljs" data-lang="bash">$ oc get secret alertmanager-default -o go-template='{{index .data "alertmanager.yaml" | base64decode }}'

global:
  resolve_timeout: 10m
route:
  group_by: ['job']
  group_wait: 30s
  group_interval: 5m
  repeat_interval: 12h
  receiver: 'null'
receivers:
- name: 'null'</code></pre>
</div>
</div>
</li>
<li>
<p>Run the <code>curl</code> command against the <code>alertmanager-proxy</code> service to retrieve the status and <code>configYAML</code> contents, and verify that the supplied configuration matches the configuration in Alertmanager:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-bash hljs" data-lang="bash">$ oc run curl -it --serviceaccount=prometheus-k8s --restart='Never' --image=radial/busyboxplus:curl -- sh -c "curl -k -H \"Content-Type: application/json\" -H \"Authorization: Bearer \$(cat /var/run/secrets/kubernetes.io/serviceaccount/token)\" https://default-alertmanager-proxy:9095/api/v1/status"

{"status":"success","data":{"configYAML":"...",...}}</code></pre>
</div>
</div>
</li>
<li>
<p>Verify that the <code>configYAML</code> field contains the changes you expect.</p>
</li>
<li>
<p>To clean up the environment, delete the <code>curl</code> pod:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">$ oc delete pod curl

pod "curl" deleted</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="ulist">
<div class="title">Additional resources</div>
<ul>
<li>
<p>For more information about the OpenShift secret and the Prometheus operator, see <a href="https://github.com/coreos/prometheus-operator/blob/master/Documentation/user-guides/alerting.md">Prometheus user guide on alerting</a>.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="creating-an-alert-route-with-templating-in-alertmanager_assembly-advanced-features">Creating an alert route with templating in Alertmanager</h4>
<div class="paragraph _abstract">
<p>Use Alertmanager to deliver alerts to an external system, such as email, IRC, or other notification channel. The Prometheus Operator manages the Alertmanager configuration as a OpenShift secret. By default, Service&#160;Telemetry&#160;Framework (STF) deploys a basic configuration that results in no receivers:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">alertmanager.yaml: |-
  global:
    resolve_timeout: 5m
  route:
    group_by: ['job']
    group_wait: 30s
    group_interval: 5m
    repeat_interval: 12h
    receiver: 'null'
  receivers:
  - name: 'null'</code></pre>
</div>
</div>
<div class="paragraph">
<p>If the <code>alertmanagerConfigManifest</code> parameter contains a custom template, for example, to construct the title and text of the sent alert, deploy the contents of the <code>alertmanagerConfigManifest</code> by using a base64-encoded configuration.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Log in to OpenShift.</p>
</li>
<li>
<p>Change to the <code>service-telemetry</code> namespace:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">$ oc project service-telemetry</code></pre>
</div>
</div>
</li>
<li>
<p>Edit the <code>ServiceTelemetry</code> object for your STF deployment:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">$ oc edit stf default</code></pre>
</div>
</div>
</li>
<li>
<p>To deploy a custom Alertmanager route with STF, you must pass an <code>alertmanagerConfigManifest</code> parameter to the Service Telemetry Operator that results in an updated secret that is managed by the Prometheus Operator:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-yaml hljs" data-lang="yaml">apiVersion: infra.watch/v1beta1
kind: ServiceTelemetry
metadata:
  name: default
  namespace: service-telemetry
spec:
  backends:
    metrics:
      prometheus:
        enabled: true
  alertmanagerConfigManifest: |
    apiVersion: v1
    kind: Secret
    metadata:
      name: 'alertmanager-default'
      namespace: 'service-telemetry'
    type: Opaque
    data:
      alertmanager.yaml: Z2xvYmFsOgogIHJlc29sdmVfdGltZW91dDogMTBtCiAgc2xhY2tfYXBpX3VybDogPHNsYWNrX2FwaV91cmw+CnJlY2VpdmVyczoKICAtIG5hbWU6IHNsYWNrCiAgICBzbGFja19jb25maWdzOgogICAgLSBjaGFubmVsOiAjc3RmLWFsZXJ0cwogICAgICB0aXRsZTogfC0KICAgICAgICAuLi4KICAgICAgdGV4dDogPi0KICAgICAgICAuLi4Kcm91dGU6CiAgZ3JvdXBfYnk6IFsnam9iJ10KICBncm91cF93YWl0OiAzMHMKICBncm91cF9pbnRlcnZhbDogNW0KICByZXBlYXRfaW50ZXJ2YWw6IDEyaAogIHJlY2VpdmVyOiAnc2xhY2snCg==</code></pre>
</div>
</div>
</li>
<li>
<p>Verify that the configuration has been applied to the secret:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-bash hljs" data-lang="bash">$ oc get secret alertmanager-default -o go-template='{{index .data "alertmanager.yaml" | base64decode }}'

global:
  resolve_timeout: 10m
  slack_api_url: &lt;slack_api_url&gt;
receivers:
  - name: slack
    slack_configs:
    - channel: #stf-alerts
      title: |-
        ...
      text: &gt;-
        ...
route:
  group_by: ['job']
  group_wait: 30s
  group_interval: 5m
  repeat_interval: 12h
  receiver: 'slack'</code></pre>
</div>
</div>
</li>
<li>
<p>Run the <code>curl</code> command against the <code>alertmanager-proxy</code> service to retrieve the status and <code>configYAML</code> contents, and verify that the supplied configuration matches the configuration in Alertmanager:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-bash hljs" data-lang="bash">$ oc run curl -it --serviceaccount=prometheus-k8s --restart='Never' --image=radial/busyboxplus:curl -- sh -c "curl -k -H \"Content-Type: application/json\" -H \"Authorization: Bearer \$(cat /var/run/secrets/kubernetes.io/serviceaccount/token)\" https://default-alertmanager-proxy:9095/api/v1/status"

{"status":"success","data":{"configYAML":"...",...}}</code></pre>
</div>
</div>
</li>
<li>
<p>Verify that the <code>configYAML</code> field contains the changes you expect.</p>
</li>
<li>
<p>To clean up the environment, delete the <code>curl</code> pod:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">$ oc delete pod curl

pod "curl" deleted</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="ulist">
<div class="title">Additional resources</div>
<ul>
<li>
<p>For more information about the OpenShift secret and the Prometheus operator, see <a href="https://github.com/coreos/prometheus-operator/blob/master/Documentation/user-guides/alerting.md">Prometheus user guide on alerting</a>.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="configuring-snmp-traps_assembly-advanced-features">Configuring SNMP traps</h3>
<div class="paragraph _abstract">
<p>You can integrate Service&#160;Telemetry&#160;Framework (STF) with an existing infrastructure monitoring platform that receives notifications through SNMP traps. To enable SNMP traps, modify the <code>ServiceTelemetry</code> object and configure the <code>snmpTraps</code> parameters.</p>
</div>
<div class="paragraph">
<p>For more information about configuring alerts, see <a href="#alerts_assembly-advanced-features">Alerts in Service&#160;Telemetry&#160;Framework</a>.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>Know the IP address or hostname of the SNMP trap receiver where you want to send the alerts</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>To enable SNMP traps, modify the <code>ServiceTelemetry</code> object:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">$ oc edit stf default</code></pre>
</div>
</div>
</li>
<li>
<p>Set the <code>alerting.alertmanager.receivers.snmpTraps</code> parameters:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: infra.watch/v1beta1
kind: ServiceTelemetry
...
spec:
  ...
  alerting:
    alertmanager:
      receivers:
        snmpTraps:
          enabled: true
          target: 10.10.10.10</code></pre>
</div>
</div>
</li>
<li>
<p>Ensure that you set the value of <code>target</code> to the IP address or hostname of the SNMP trap receiver.</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="high-availability_assembly-advanced-features">High availability</h3>
<div class="paragraph _abstract">
<p>With high availability, Service&#160;Telemetry&#160;Framework (STF) can rapidly recover from failures in its component services. Although OpenShift restarts a failed pod if nodes are available to schedule the workload, this recovery process might take more than one minute, during which time events and metrics are lost. A high availability configuration includes multiple copies of STF components, which reduces recovery time to approximately 2 seconds. To protect against failure of an OpenShift node, deploy STF to an OpenShift cluster with three or more nodes.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
STF is not yet a fully fault tolerant system. Delivery of metrics and events during the recovery period is not guaranteed.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Enabling high availability has the following effects:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Three Elasticsearch pods run instead of the default one.</p>
</li>
<li>
<p>The following components run two pods instead of the default one:</p>
<div class="ulist">
<ul>
<li>
<p>Apache&#160;Qpid&#160;Dispatch&#160;Router</p>
</li>
<li>
<p>Alertmanager</p>
</li>
<li>
<p>Prometheus</p>
</li>
<li>
<p>Events Smart Gateway</p>
</li>
<li>
<p>Metrics Smart Gateway</p>
</li>
</ul>
</div>
</li>
<li>
<p>Recovery time from a lost pod in any of these services reduces to approximately 2 seconds.</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="configuring-high-availability_assembly-advanced-features">Configuring high availability</h4>
<div class="paragraph _abstract">
<p>To configure Service&#160;Telemetry&#160;Framework (STF) for high availability, add <code>highAvailability.enabled: true</code> to the ServiceTelemetry object in OpenShift. You can set this parameter at installation time or, if you already deployed STF, complete the following steps:</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Log in to OpenShift.</p>
</li>
<li>
<p>Change to the <code>service-telemetry</code> namespace:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">$ oc project service-telemetry</code></pre>
</div>
</div>
</li>
<li>
<p>Use the oc command to edit the ServiceTelemetry object:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">$ oc edit stf default</code></pre>
</div>
</div>
</li>
<li>
<p>Add <code>highAvailability.enabled: true</code> to the <code>spec</code> section:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: infra.watch/v1beta1
kind: ServiceTelemetry
...
spec:
  ...
  highAvailability:
    enabled: true</code></pre>
</div>
</div>
</li>
<li>
<p>Save your changes and close the object.</p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect2">
<h3 id="ephemeral-storage_assembly-advanced-features">Ephemeral storage</h3>
<div class="paragraph _abstract">
<p>You can use ephemeral storage to run Service&#160;Telemetry&#160;Framework (STF) without persistently storing data in your OpenShift cluster.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
If you use ephemeral storage, you might experience data loss if a pod is restarted, updated, or rescheduled onto another node. Use ephemeral storage only for development or testing, and not production environments.
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="configuring-ephemeral-storage_assembly-advanced-features">Configuring ephemeral storage</h4>
<div class="paragraph _abstract">
<p>To configure STF components for ephemeral storage, add <code>...storage.strategy: ephemeral</code> to the corresponding parameter. For example, to enable ephemeral storage for the Prometheus back end, set <code>backends.metrics.prometheus.storage.strategy: ephemeral</code>. Components that support configuration of ephemeral storage include <code>alerting.alertmanager</code>, <code>backends.metrics.prometheus</code>, and <code>backends.events.elasticsearch</code>. You can add ephemeral storage configuration at installation time or, if you already deployed STF, complete the following steps:</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Log in to OpenShift.</p>
</li>
<li>
<p>Change to the <code>service-telemetry</code> namespace:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">$ oc project service-telemetry</code></pre>
</div>
</div>
</li>
<li>
<p>Edit the ServiceTelemetry object:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">$ oc edit stf default</code></pre>
</div>
</div>
</li>
<li>
<p>Add the <code>...storage.strategy: ephemeral</code> parameter to the <code>spec</code> section of the relevant component:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: infra.watch/v1beta1
kind: ServiceTelemetry
metadata:
  name: stf-default
  namespace: service-telemetry
spec:
  alerting:
    enabled: true
    alertmanager:
      storage:
        strategy: ephemeral
  backends:
    metrics:
      prometheus:
        enabled: true
        storage:
          strategy: ephemeral
    events:
      elasticsearch:
        enabled: true
        storage:
          strategy: ephemeral</code></pre>
</div>
</div>
</li>
<li>
<p>Save your changes and close the object.</p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect2">
<h3 id="observability-strategy-in-service-telemetry-framework_assembly-advanced-features">Observability Strategy in Service Telemetry Framework</h3>
<div class="paragraph _abstract">
<p>Service&#160;Telemetry&#160;Framework (STF) does not include storage backends and alerting tools. STF uses community operators to deploy Prometheus, Alertmanager, Grafana, and Elasticsearch. STF makes requests to these community operators to create instances of each application configured to work with STF.</p>
</div>
<div class="paragraph">
<p>Instead of having Service Telemetry Operator create custom resource requests, you can use your own deployments of these applications or other compatible applications, and scrape the metrics Smart Gateways for delivery to your own Prometheus-compatible system for telemetry storage. If you set the observability strategy to use alternative backends instead, persistent or ephemeral storage is not required for STF.</p>
</div>
<div class="sect3">
<h4 id="configuring-observability-strategy_assembly-advanced-features">Configuring an alternate observability strategy</h4>
<div class="paragraph _abstract">
<p>To configure STF to skip the deployment of storage, visualization, and alerting backends, add <code>observabilityStrategy: none</code> to the ServiceTelemetry spec. In this mode, only Apache&#160;Qpid&#160;Dispatch&#160;Router routers and metrics Smart Gateways are deployed, and you must configure an external Prometheus-compatible system to collect metrics from the STF Smart Gateways.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Currently, only metrics are supported when you set <code>observabilityStrategy</code> to <code>none</code>.  Events Smart Gateways are not deployed.
</td>
</tr>
</table>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Create a <code>ServiceTelemetry</code> object with the property <code>observabilityStrategy: none</code> in the <code>spec</code> parameter. The manifest shows results in a default deployment of STF that is suitable for receiving telemetry from a single cloud with all metrics collector types.</p>
<div class="listingblock white-space-pre">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-yaml hljs" data-lang="yaml">$ oc apply -f - &lt;&lt;EOF
apiVersion: infra.watch/v1beta1
kind: ServiceTelemetry
metadata:
  name: default
  namespace: service-telemetry
spec:
  observabilityStrategy: none
EOF</code></pre>
</div>
</div>
</li>
<li>
<p>To verify that all workloads are operating correctly, view the pods and the status of each pod:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-bash hljs" data-lang="bash">$ oc get pods
NAME                                                      READY   STATUS    RESTARTS   AGE
default-cloud1-ceil-meter-smartgateway-59c845d65b-gzhcs   3/3     Running   0          132m
default-cloud1-coll-meter-smartgateway-75bbd948b9-d5phm   3/3     Running   0          132m
default-cloud1-sens-meter-smartgateway-7fdbb57b6d-dh2g9   3/3     Running   0          132m
default-interconnect-668d5bbcd6-57b2l                     1/1     Running   0          132m
interconnect-operator-b8f5bb647-tlp5t                     1/1     Running   0          47h
service-telemetry-operator-566b9dd695-wkvjq               1/1     Running   0          156m
smart-gateway-operator-58d77dcf7-6xsq7                    1/1     Running   0          47h</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<div class="title">Additional resources</div>
<p>For more information about configuring additional clouds or to change the set of supported collectors, see <a href="#deploying-smart-gateways_assembly-completing-the-stf-configuration">Deploying Smart Gateways</a></p>
</div>
</div>
<div class="sect3">
<h4 id="configuring-openshift-monitoring_assembly-advanced-features">Configuring openshift-monitoring to consume metrics from STF</h4>
<div class="paragraph _abstract">
<p>You can configure openshift-monitoring to consume metrics from STF so that you can use the existing Prometheus deployment for STF data. This configuration is useful in combination with <code>observabilityStrategy: none</code> as an alternative to the community operators. You must add a label to the namespace where STF is deployed, and create ServiceMonitor objects for each Smart Gateway intended to be scraped.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Edit the namespace object:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">$ oc edit namespace service-telemetry</code></pre>
</div>
</div>
</li>
<li>
<p>Add the <code>openshift.io/cluster-monitoring: "true"</code> label under the <code>metadata</code> property:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">metadata:
  labels:
    openshift.io/cluster-monitoring: "true"</code></pre>
</div>
</div>
</li>
<li>
<p>Create a ServiceMonitor object for each Smart Gateway:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-bash hljs" data-lang="bash">$ for collector_type in ceil coll sens; do oc apply -f &lt;(sed -e "s/&lt;&lt;COLLECTOR_TYPE&gt;&gt;/${collector_type}/g" &lt;&lt; EOF
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  labels:
    app: smart-gateway
  name: default-cloud1-&lt;&lt;COLLECTOR_TYPE&gt;&gt;-meter
  namespace: service-telemetry
spec:
  endpoints:
  - bearerTokenFile: /var/run/secrets/kubernetes.io/serviceaccount/token
    interval: 10s
    metricRelabelings:
    - action: labeldrop
      regex: pod
    - action: labeldrop
      regex: namespace
    - action: labeldrop
      regex: instance
    - action: labeldrop
      regex: job
    - action: labeldrop
      regex: publisher
    port: prom-https
    scheme: https
    tlsConfig:
      caFile: /etc/prometheus/configmaps/serving-certs-ca-bundle/service-ca.crt
      serverName: default-cloud1-&lt;&lt;COLLECTOR_TYPE&gt;&gt;-meter.service-telemetry.svc
  namespaceSelector:
    matchNames:
    - service-telemetry
  selector:
    matchLabels:
      app: smart-gateway
      smart-gateway: default-cloud1-&lt;&lt;COLLECTOR_TYPE&gt;&gt;-meter
EOF
); done
servicemonitor.monitoring.coreos.com/default-cloud1-ceil-meter configured
servicemonitor.monitoring.coreos.com/default-cloud1-coll-meter configured
servicemonitor.monitoring.coreos.com/default-cloud1-sens-meter configured</code></pre>
</div>
</div>
</li>
<li>
<p>To verify the successful configuration of openshift-monitoring, ensure that Smart Gateway metrics appear in Prometheus.</p>
</li>
<li>
<p>Retrieve the route for the openshift-monitoring prometheus:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-bash hljs" data-lang="bash">$ oc get route -n openshift-monitoring prometheus-k8s
NAME             HOST/PORT                                              PATH   SERVICES         PORT   TERMINATION          WILDCARD
prometheus-k8s   prometheus-k8s-openshift-monitoring.apps.infra.watch          prometheus-k8s   web    reencrypt/Redirect   None</code></pre>
</div>
</div>
</li>
<li>
<p>Visit the host in your browser and log in with OpenShift credentials.</p>
</li>
<li>
<p>Verify that the following targets are visible under the <code>Status -&gt; Targets</code> tab:</p>
<div class="ulist">
<ul>
<li>
<p>service-telemetry/default-cloud1-ceil-meter/0</p>
</li>
<li>
<p>service-telemetry/default-cloud1-coll-meter/0</p>
</li>
<li>
<p>service-telemetry/default-cloud1-sens-meter/0</p>
<div class="paragraph">
<p>If there are problems with the configuration, find them on this page.</p>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>Issue the following queries on the <code>Graph</code> tab:</p>
<div class="ulist">
<ul>
<li>
<p><code>sg_total_collectd_metric_decode_count</code></p>
</li>
<li>
<p><code>sg_total_ceilometer_metric_decode_count</code></p>
</li>
<li>
<p><code>sg_total_sensubility_metric_decode_count</code></p>
</li>
</ul>
</div>
</li>
<li>
<p>There should be one result from each Smart Gateway, as shown in the following example:</p>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If the values returned are 0, it means that STF is not receiving that type of metric yet but as long as a result is returned, the configuration of openshift-monitoring is correct.
</td>
</tr>
</table>
</div>
<div class="ulist">
<ul>
<li>
<p><code>sg_total_collectd_metric_decode_count{container="sg-core", endpoint="prom-https", service="default-cloud1-coll-meter", source="SG"}</code></p>
</li>
<li>
<p><code>sg_total_ceilometer_metric_decode_count{container="sg-core", endpoint="prom-https", service="default-cloud1-ceil-meter", source="SG"}</code></p>
</li>
<li>
<p><code>sg_total_sensubility_metric_decode_count{container="sg-core", endpoint="prom-https", service="default-cloud1-sens-meter", source="SG"}</code></p>
</li>
</ul>
</div>
</li>
</ol>
</div>
</div>
</div>
<div class="sect2">
<h3 id="resource-usage-of-openstack-services_assembly-advanced-features">Resource usage of OpenStack services</h3>
<div class="paragraph _abstract">
<p>You can monitor the resource usage of the OpenStack (OSP) services, such as the APIs and other infrastructure processes, to identify bottlenecks in the overcloud by showing services that run out of compute power. Resource usage monitoring is enabled by default.</p>
</div>
<div class="ulist">
<div class="title">Additional resources</div>
<ul>
<li>
<p>To disable resource usage monitoring, see <a href="#disabling-resource-usage-monitoring-of-openstack-services_assembly-advanced-features">Disabling resource usage monitoring of OpenStack services</a>.</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="disabling-resource-usage-monitoring-of-openstack-services_assembly-advanced-features">Disabling resource usage monitoring of OpenStack services</h4>
<div class="paragraph">
<p>To disable the monitoring of OSP containerized service resource usage, you must set the <code>CollectdEnableLibpodstats</code> parameter to <code>false</code>.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>You have created the <code>stf-connectors.yaml</code> file. For more information, see <a href="#configuring-red-hat-openstack-platform-overcloud-for-stf_assembly-completing-the-stf-configuration">Deploying OpenStack overcloud for Service&#160;Telemetry&#160;Framework</a>.</p>
</li>
<li>
<p>You are using the most current version of OpenStack (OSP) Wallaby.</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Open the <code>stf-connectors.yaml</code> file and add the <code>CollectdEnableLibpodstats</code> parameter to override the setting in <code>enable-stf.yaml</code>. Ensure that <code>stf-connectors.yaml</code> is called from the <code>openstack overcloud deploy</code> command after <code>enable-stf.yaml</code>:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">  CollectdEnableLibpodstats: false</code></pre>
</div>
</div>
</li>
<li>
<p>Continue with the overcloud deployment procedure. For more information, see <a href="#deploying-the-overcloud_assembly-completing-the-stf-configuration">Deploying the overcloud</a>.</p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect2">
<h3 id="container-health-and-api-status_assembly-advanced-features">OpenStack API status and containerized services health</h3>
<div class="paragraph _abstract">
<p>You can use the OCI (Open Container Initiative) standard to assess the container health status of each OpenStack (OSP) service by periodically running a health check script. Most OSP services implement a health check that logs issues and returns a binary status. For the OSP APIs, the health checks query the root endpoint and determine the health based on the response time.</p>
</div>
<div class="paragraph">
<p>Monitoring of OSP container health and API status is enabled by default.</p>
</div>
<div class="ulist">
<div class="title">Additional resources</div>
<ul>
<li>
<p>To disable OSP container health and API status monitoring, see <a href="#disabling-container-health-and-api-status-monitoring_assembly-advanced-features">Disabling container health and API status monitoring</a>.</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="disabling-container-health-and-api-status-monitoring_assembly-advanced-features">Disabling container health and API status monitoring</h4>
<div class="paragraph _abstract">
<p>To disable OSP containerized service health and API status monitoring, you must set the <code>CollectdEnableSensubility</code> parameter to <code>false</code>.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>You have created the <code>stf-connectors.yaml</code> file in your templates directory. For more information, see <a href="#configuring-red-hat-openstack-platform-overcloud-for-stf_assembly-completing-the-stf-configuration">Deploying OpenStack overcloud for Service&#160;Telemetry&#160;Framework</a>.</p>
</li>
<li>
<p>You are using the most current version of OpenStack (OSP) Wallaby.</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Open the <code>stf-connectors.yaml</code> and add the <code>CollectdEnableSensubility</code> parameter to override the setting in <code>enable-stf.yaml</code>. Ensure that <code>stf-connectors.yaml</code> is called from the <code>openstack overcloud deploy</code> command after <code>enable-stf.yaml</code>:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">CollectdEnableSensubility: false</code></pre>
</div>
</div>
</li>
<li>
<p>Continue with the overcloud deployment procedure. For more information, see <a href="#deploying-the-overcloud_assembly-completing-the-stf-configuration">Deploying the overcloud</a>.</p>
</li>
</ol>
</div>
<div class="ulist">
<div class="title">Additional resources</div>
<ul>
<li>
<p>For more information about multiple cloud addresses, see <a href="#configuring-multiple-clouds_assembly-completing-the-stf-configuration">Configuring multiple clouds</a>.</p>
</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="assembly-renewing-the-amq-interconnect-certificate_assembly">Renewing the Apache&#160;Qpid&#160;Dispatch&#160;Router certificate</h2>
<div class="sectionbody">
<div class="paragraph _abstract">
<p>Periodically, you must renew the CA certificate that secures the Apache&#160;Qpid&#160;Dispatch&#160;Router connection between OpenStack (OSP) and Service&#160;Telemetry&#160;Framework (STF) when the certificate expires. The renewal is handled automatically by the cert-manager component in OpenShift, but you must manually copy the renewed certificate to your OSP nodes.</p>
</div>
<div class="sect2">
<h3 id="proc-checking-for-an-expired-amq-interconnect-ca-certificate_assembly-renewing-the-amq-interconnect-certificate">Checking for an expired Apache&#160;Qpid&#160;Dispatch&#160;Router CA certificate</h3>
<div class="paragraph _abstract">
<p>When the CA certificate expires the Apache&#160;Qpid&#160;Dispatch&#160;Router connections will remain up, but will be unable to reconnect if they are interrupted. Eventually you will find that some or all of the connections from your OpenStack (OSP) Routers have failed, showing errors on both sides, and the expiry (or "Not After") field in your CA certificate will be in the past.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Log in to OpenShift.</p>
</li>
<li>
<p>Change to the <code>service-telemetry</code> namespace:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">$ oc project service-telemetry</code></pre>
</div>
</div>
</li>
<li>
<p>Check that some or all Router connections have failed:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-bash hljs" data-lang="bash">$ oc exec -it $(oc get po -l application=default-interconnect -o jsonpath='{.items[0].metadata.name}') -- qdstat --connections | grep Router | wc
      0       0       0</code></pre>
</div>
</div>
</li>
<li>
<p>Check for this error in the OpenShift-hosted Apache&#160;Qpid&#160;Dispatch&#160;Router logs:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-bash hljs" data-lang="bash">$ oc logs -l application=default-interconnect | tail
[...]
2022-11-10 20:51:22.863466 +0000 SERVER (info) [C261] Connection from 10.10.10.10:34570 (to 0.0.0.0:5671) failed: amqp:connection:framing-error SSL Failure: error:140940E5:SSL routines:ssl3_read_bytes:ssl handshake failure</code></pre>
</div>
</div>
</li>
<li>
<p>Log into your OSP undercloud.</p>
</li>
<li>
<p>Check for this error in the OSP-hosted Apache&#160;Qpid&#160;Dispatch&#160;Router logs of a node where the connection has failed:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-bash hljs" data-lang="bash">$ ssh controller-0.ctlplane -- sudo tail /var/log/containers/metrics_qdr/metrics_qdr.log
[...]
2022-11-10 20:50:44.311646 +0000 SERVER (info) [C137] Connection to default-interconnect-5671-service-telemetry.apps.mycluster.com:443 failed: amqp:connection:framing-error SSL Failure: error:0A000086:SSL routines::certificate verify failed</code></pre>
</div>
</div>
</li>
<li>
<p>Confirm that the CA certificate has expired by examining the file on an OSP node:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-bash hljs" data-lang="bash">$ ssh controller-0.ctlplane -- cat /var/lib/config-data/puppet-generated/metrics_qdr/etc/pki/tls/certs/CA_sslProfile.pem | openssl x509 -text | grep "Not After"
            Not After : Nov 10 20:31:16 2022 GMT

$ date
Mon Nov 14 11:10:40 EST 2022</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="proc-updating-the-amq-interconnect-ca-certificate_assembly-renewing-the-amq-interconnect-certificate">Updating the Apache&#160;Qpid&#160;Dispatch&#160;Router CA certificate</h3>
<div class="paragraph _abstract">
<p>To update the Apache&#160;Qpid&#160;Dispatch&#160;Router certificate, you will need to export it from OpenShift and copy it to your OpenStack (OSP) nodes.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Log in to OpenShift.</p>
</li>
<li>
<p>Change to the <code>service-telemetry</code> namespace:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">$ oc project service-telemetry</code></pre>
</div>
</div>
</li>
<li>
<p>Export the CA certificate to <code>STFCA.pem</code>:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-bash hljs" data-lang="bash">$ oc get secret/default-interconnect-selfsigned -o jsonpath='{.data.ca\.crt}' | base64 -d &gt; STFCA.pem</code></pre>
</div>
</div>
</li>
<li>
<p>Copy STFCA.pem to your OSP undercloud.</p>
</li>
<li>
<p>Log into your OSP undercloud.</p>
</li>
<li>
<p>Edit the stf-connectors.yaml file to contain the new caCertFileContent (For more information, see <a href="#configuring-the-stf-connection-for-the-overcloud_assembly-completing-the-stf-configuration">Configuring the STF connection for the overcloud</a>)</p>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
You do not need to perform an overcloud deploy after performing the steps below. We edit the stf-connectors.yaml file only to make sure that future deployments will not overwrite the new CA certificate.
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Copy the STFCA.pem file to each OSP overcloud node:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-bash hljs" data-lang="bash">[stack@undercloud-0 ~]$ ansible -i overcloud-deploy/overcloud/tripleo-ansible-inventory.yaml allovercloud -b -m copy -a "src=STFCA.pem dest=/var/lib/config-data/puppet-generated/metrics_qdr/etc/pki/tls/certs/CA_sslProfile.pem"</code></pre>
</div>
</div>
</li>
<li>
<p>Restart the metrics_qdr container on each OSP overcloud node:</p>
</li>
</ol>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2022-12-01 20:03:25 UTC
</div>
</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.3/highlight.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.3/languages/yaml.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.3/languages/bash.min.js"></script>
<script>
if (!hljs.initHighlighting.called) {
  hljs.initHighlighting.called = true
  ;[].slice.call(document.querySelectorAll('pre.highlight > code[data-lang]')).forEach(function (el) { hljs.highlightBlock(el) })
}
</script>
</body>
</html>